<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ReceptÃ¶versÃ¤ttaren</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body { margin: 0; background: #f5f0e8; font-family: sans-serif; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media print { button { display: none !important; } }
    .info-btn:hover { background: rgba(201,168,76,0.18) !important; transform: scale(1.05); }
    .info-btn { transition: background .15s, transform .1s; }
    .img-slot:hover { border-color: #2d4a3e !important; }
    .tog-btn { transition: background .15s, color .15s; }
    .lang-opt:hover { background: #ede6d6 !important; }
  </style>
</head>
<body>
<div id="root"></div>
<script>
const h = React.createElement;
const { useState, useEffect, useRef } = React;

// â”€â”€ i18n data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const UI_STRINGS={"sv":{"langName":"Svenska","subtitle":"ReceptÃ¶versÃ¤ttning & mÃ¥ttomvandling","infoBtn":"Om tjÃ¤nsten","infoTitle":"Om ReceptÃ¶versÃ¤ttaren","infoWelcome":"VÃ¤lkommen till ReceptÃ¶versÃ¤ttaren!","infoP1":"HÃ¤r kan du Ã¶versÃ¤tta ett recept frÃ¥n ett valfritt sprÃ¥k till ett annat valfritt sprÃ¥k.","infoP2":"VÃ¤lj om du vill Ã¶versÃ¤tta ett recept frÃ¥n en kopierad text, genom att ange en adress till en webbsida (URL) eller fotografera en sida i en kokbok och ladda upp fotot.","infoP3":"VÃ¤lj ocksÃ¥ om du vill ha mÃ¥tt i metriska enheter (standard) eller i imperial units.","infoFooter":"Kom ihÃ¥g att ReceptÃ¶versÃ¤ttaren Ã¤r en ren Ã¶versÃ¤ttningstjÃ¤nst och att du bara fÃ¥r anvÃ¤nda Ã¶versÃ¤ttningen fÃ¶r privat bruk.","tabText":"Klistra in text","tabUrl":"Webbadress (URL)","tabImg":"Foto ğŸ“·","toLang":"Ã–versÃ¤tt till","fromLang":"OriginalsprÃ¥k","autoDetect":"Automatisk igenkÃ¤nning","unitsLabel":"MÃ¥ttenheter","metric":"Metriska (dl, g, Â°C)","imperial":"Imperial (cups, oz, Â°F)","pasteLabel":"Originalrecept â€” valfritt sprÃ¥k","clear":"Rensa","urlLabel":"Receptets webbadress","worksWith":"Fungerar med:","imgSlotFirst":"Tryck eller dra hit ett foto","imgSlotAdd":"LÃ¤gg till foto","imgFormat":"JPG Â· PNG Â· HEIC Â· Max 1200Ã—1200px","imgCount1":" av ","imgCount2":" bilder tillagda","imgCountMore":" â€” du kan lÃ¤gga till fler","imgTipLabel":"Tips: ","imgTip":"Fungerar med kokbokssidor, handskrivna recept och menyer â€” pÃ¥ vilket sprÃ¥k som helst. Ladda upp flera bilder om receptet Ã¤r lÃ¤ngre.","converts":"Konverteras","btnTranslate":"Ã–versÃ¤tt recept","btnImg":"ğŸ“· LÃ¤s och Ã¶versÃ¤tt","copyBtn":"Kopiera text","copiedBtn":"âœ“ Kopierat","pdfBtn":"Ladda ner PDF","resultFrom":"Ã–versatt recept â€” frÃ¥n","resultTo":"till","resultPrefix":"Ã–versatt recept â€”","scaleLabel":"Skala:","ingredients":"Ingredienser","steps":"GÃ¶r sÃ¥ hÃ¤r","notes":"Tips & noteringar","source":"KÃ¤lla: ","siteTitle":"ReceptÃ¶versÃ¤ttaren","titlePart1":"Recept","titlePart2":"Ã¶versÃ¤ttaren","ttsPlay":"LÃ¤s upp recept","ttsPause":"Paus","ttsResume":"FortsÃ¤tt","ttsStop":"Avsluta","ttsOf":"av","ttsIngHeading":"Ingredienser","ttsStepWord":"Steg","ttsRead":"LÃ¤s upp","ttsIngHeader":"Ingredienser","ttsStepsHeader":"Steg","ttsTitle":"Titel","ttsNotes":"Anteckningar"},"en":{"langName":"English","subtitle":"Recipe Translation & Measurement Conversion","infoBtn":"About","infoTitle":"About the Recipe Translator","infoWelcome":"Welcome to the Recipe Translator!","infoP1":"Here you can translate a recipe from any language to any other language.","infoP2":"Choose whether to translate from pasted text, by entering a web address (URL), or by photographing a cookbook page and uploading the photo.","infoP3":"Also choose whether you want measurements in metric units (default) or imperial units.","infoFooter":"Remember that the Recipe Translator is a pure translation service and that you may only use the translation for personal use.","tabText":"Paste text","tabUrl":"Web address (URL)","tabImg":"Photo ğŸ“·","toLang":"Translate to","fromLang":"Original language","autoDetect":"Auto-detect","unitsLabel":"Measurement units","metric":"Metric (dl, g, Â°C)","imperial":"Imperial (cups, oz, Â°F)","pasteLabel":"Original recipe â€” any language","clear":"Clear","urlLabel":"Recipe web address","worksWith":"Works with:","imgSlotFirst":"Tap or drag a photo here","imgSlotAdd":"Add photo","imgFormat":"JPG Â· PNG Â· HEIC Â· Max 1200Ã—1200px","imgCount1":" of ","imgCount2":" photos added","imgCountMore":" â€” you can add more","imgTipLabel":"Tip: ","imgTip":"Works with cookbook pages, handwritten recipes and menus â€” in any language. Upload multiple photos if the recipe is longer.","converts":"Converts","btnTranslate":"Translate recipe","btnImg":"ğŸ“· Read & translate","copyBtn":"Copy text","copiedBtn":"âœ“ Copied","pdfBtn":"Download PDF","resultFrom":"Translated recipe â€” from","resultTo":"to","resultPrefix":"Translated recipe â€”","scaleLabel":"Scale:","ingredients":"Ingredients","steps":"Instructions","notes":"Tips & notes","source":"Source: ","siteTitle":"Recipe Translator","titlePart1":"Recipe ","titlePart2":"Translator","ttsPlay":"Read recipe aloud","ttsPause":"Pause","ttsResume":"Resume","ttsStop":"Stop","ttsOf":"of","ttsIngHeading":"Ingredients","ttsStepWord":"Step","ttsRead":"Read aloud","ttsIngHeader":"Ingredients","ttsStepsHeader":"Step","ttsTitle":"Title","ttsNotes":"Notes"},"da":{"langName":"Dansk","subtitle":"ReceptoversÃ¦ttelse & mÃ¥lomsÃ¦tning","infoBtn":"Om tjenesten","infoTitle":"Om ReceptoversÃ¦tteren","infoWelcome":"Velkommen til ReceptoversÃ¦tteren!","infoP1":"Her kan du oversÃ¦tte en opskrift fra et vilkÃ¥rligt sprog til et andet vilkÃ¥rligt sprog.","infoP2":"VÃ¦lg om du vil oversÃ¦tte en opskrift fra kopieret tekst, ved at angive en webadresse (URL) eller fotografere en side i en kogebog og uploade fotoet.","infoP3":"VÃ¦lg ogsÃ¥ om du vil have mÃ¥l i metriske enheder (standard) eller i imperial units.","infoFooter":"Husk at ReceptoversÃ¦tteren er en ren oversÃ¦ttelsestjeneste, og at du kun mÃ¥ bruge oversÃ¦ttelsen til privat brug.","tabText":"IndsÃ¦t tekst","tabUrl":"Webadresse (URL)","tabImg":"Foto ğŸ“·","toLang":"OversÃ¦t til","fromLang":"Originalsprog","autoDetect":"Automatisk genkendelse","unitsLabel":"MÃ¥leenheder","metric":"Metrisk (dl, g, Â°C)","imperial":"Imperial (cups, oz, Â°F)","pasteLabel":"Originalopskrift â€” valgfrit sprog","clear":"Ryd","urlLabel":"Opskriftens webadresse","worksWith":"Fungerer med:","imgSlotFirst":"Tryk eller trÃ¦k et foto hertil","imgSlotAdd":"TilfÃ¸j foto","imgFormat":"JPG Â· PNG Â· HEIC Â· Max 1200Ã—1200px","imgCount1":" af ","imgCount2":" fotos tilfÃ¸jet","imgCountMore":" â€” du kan tilfÃ¸je flere","imgTipLabel":"Tips: ","imgTip":"Fungerer med kogebogssider, hÃ¥ndskrevne opskrifter og menuer â€” pÃ¥ alle sprog. Upload flere fotos hvis opskriften er lÃ¦ngere.","converts":"Omregnes","btnTranslate":"OversÃ¦t opskrift","btnImg":"ğŸ“· LÃ¦s og oversÃ¦t","copyBtn":"KopiÃ©r tekst","copiedBtn":"âœ“ Kopieret","pdfBtn":"Download PDF","resultFrom":"Oversat opskrift â€” fra","resultTo":"til","resultPrefix":"Oversat opskrift â€”","scaleLabel":"Skaler:","ingredients":"Ingredienser","steps":"SÃ¥dan gÃ¸r du","notes":"Tips & bemÃ¦rkninger","source":"Kilde: ","siteTitle":"ReceptoversÃ¦tteren","titlePart1":"Recept","titlePart2":"oversÃ¦tteren","ttsPlay":"OplÃ¦s opskrift","ttsPause":"Pause","ttsResume":"FortsÃ¦t","ttsStop":"Stop","ttsOf":"af","ttsIngHeading":"Ingredienser","ttsStepWord":"Trin","ttsRead":"OplÃ¦s","ttsIngHeader":"Ingredienser","ttsStepsHeader":"Trin","ttsTitle":"Titel","ttsNotes":"Notater"},"no":{"langName":"Norsk","subtitle":"Oppskriftoversettelse & mÃ¥lenhetkonvertering","infoBtn":"Om tjenesten","infoTitle":"Om Oppskriftoversetteren","infoWelcome":"Velkommen til Oppskriftoversetteren!","infoP1":"Her kan du oversette en oppskrift fra et valgfritt sprÃ¥k til et annet valgfritt sprÃ¥k.","infoP2":"Velg om du vil oversette fra limt inn tekst, ved Ã¥ oppgi en nettadresse (URL) eller fotografere en side i en kokebok og laste opp bildet.","infoP3":"Velg ogsÃ¥ om du vil ha mÃ¥l i metriske enheter (standard) eller i imperial units.","infoFooter":"Husk at tjenesten er en ren oversettingstjeneste og at du bare kan bruke oversettelsen til privat bruk.","tabText":"Lim inn tekst","tabUrl":"Nettadresse (URL)","tabImg":"Foto ğŸ“·","toLang":"Oversett til","fromLang":"OriginalsprÃ¥k","autoDetect":"Automatisk gjenkjenning","unitsLabel":"MÃ¥leenheter","metric":"Metrisk (dl, g, Â°C)","imperial":"Imperial (cups, oz, Â°F)","pasteLabel":"Originaloppskrift â€” valgfritt sprÃ¥k","clear":"TÃ¸m","urlLabel":"Oppskriftens nettadresse","worksWith":"Fungerer med:","imgSlotFirst":"Trykk eller dra et bilde hit","imgSlotAdd":"Legg til bilde","imgFormat":"JPG Â· PNG Â· HEIC Â· Maks 1200Ã—1200px","imgCount1":" av ","imgCount2":" bilder lagt til","imgCountMore":" â€” du kan legge til flere","imgTipLabel":"Tips: ","imgTip":"Fungerer med kokeboksider, hÃ¥ndskrevne oppskrifter og menyer â€” pÃ¥ alle sprÃ¥k. Last opp flere bilder hvis oppskriften er lengre.","converts":"Konverteres","btnTranslate":"Oversett oppskrift","btnImg":"ğŸ“· Les og oversett","copyBtn":"Kopier tekst","copiedBtn":"âœ“ Kopiert","pdfBtn":"Last ned PDF","resultFrom":"Oversatt oppskrift â€” fra","resultTo":"til","resultPrefix":"Oversatt oppskrift â€”","scaleLabel":"Skaler:","ingredients":"Ingredienser","steps":"Slik gjÃ¸r du det","notes":"Tips & merknader","source":"Kilde: ","siteTitle":"Oppskriftoversetteren","titlePart1":"Oppskrift","titlePart2":"oversetteren","ttsPlay":"Les opp oppskrift","ttsPause":"Pause","ttsResume":"Fortsett","ttsStop":"Stopp","ttsOf":"av","ttsIngHeading":"Ingredienser","ttsStepWord":"Trinn","ttsRead":"Les opp","ttsIngHeader":"Ingredienser","ttsStepsHeader":"Trinn","ttsTitle":"Tittel","ttsNotes":"Notater"},"fi":{"langName":"Suomi","subtitle":"ReseptikÃ¤Ã¤ntÃ¤jÃ¤ & mittayksikÃ¶iden muunnos","infoBtn":"Tietoa","infoTitle":"Tietoa reseptikÃ¤Ã¤ntÃ¤jÃ¤stÃ¤","infoWelcome":"Tervetuloa reseptikÃ¤Ã¤ntÃ¤jÃ¤Ã¤n!","infoP1":"TÃ¤Ã¤llÃ¤ voit kÃ¤Ã¤ntÃ¤Ã¤ reseptin mistÃ¤ tahansa kielestÃ¤ mihin tahansa muuhun kieleen.","infoP2":"Valitse haluatko kÃ¤Ã¤ntÃ¤Ã¤ kopioidusta tekstistÃ¤, syÃ¶ttÃ¤mÃ¤llÃ¤ verkkosivun osoitteen (URL) tai valokuvaamalla keittokirjan sivun ja lataamalla kuvan.","infoP3":"Valitse myÃ¶s haluatko mitat metrisinÃ¤ yksikkÃ¶inÃ¤ (oletus) vai imperial-yksikkÃ¶inÃ¤.","infoFooter":"Muista, ettÃ¤ tÃ¤mÃ¤ on pelkkÃ¤ kÃ¤Ã¤nnÃ¶spalvelu ja kÃ¤Ã¤nnÃ¶stÃ¤ saa kÃ¤yttÃ¤Ã¤ vain yksityiseen kÃ¤yttÃ¶Ã¶n.","tabText":"LiitÃ¤ teksti","tabUrl":"Verkko-osoite (URL)","tabImg":"Kuva ğŸ“·","toLang":"KÃ¤Ã¤nnÃ¤ kielelle","fromLang":"AlkuperÃ¤inen kieli","autoDetect":"Automaattinen tunnistus","unitsLabel":"MittayksikÃ¶t","metric":"Metriset (dl, g, Â°C)","imperial":"Imperial (cups, oz, Â°F)","pasteLabel":"AlkuperÃ¤inen resepti â€” mikÃ¤ tahansa kieli","clear":"TyhjennÃ¤","urlLabel":"Reseptin verkko-osoite","worksWith":"Toimii:","imgSlotFirst":"Napauta tai vedÃ¤ kuva tÃ¤hÃ¤n","imgSlotAdd":"LisÃ¤Ã¤ kuva","imgFormat":"JPG Â· PNG Â· HEIC Â· Max 1200Ã—1200px","imgCount1":" / ","imgCount2":" kuvaa lisÃ¤tty","imgCountMore":" â€” voit lisÃ¤tÃ¤ lisÃ¤Ã¤","imgTipLabel":"Vinkki: ","imgTip":"Toimii keittokirjasivujen, kÃ¤sinkirjoitettujen reseptien ja menujen kanssa â€” millÃ¤ tahansa kielellÃ¤. Lataa useita kuvia, jos resepti on pidempi.","converts":"Muunnetaan","btnTranslate":"KÃ¤Ã¤nnÃ¤ resepti","btnImg":"ğŸ“· Lue & kÃ¤Ã¤nnÃ¤","copyBtn":"Kopioi teksti","copiedBtn":"âœ“ Kopioitu","pdfBtn":"Lataa PDF","resultFrom":"KÃ¤Ã¤nnetty resepti â€” kielestÃ¤","resultTo":"kieleen","resultPrefix":"KÃ¤Ã¤nnetty resepti â€”","scaleLabel":"Skaalaa:","ingredients":"Ainesosat","steps":"Valmistus","notes":"Vinkit & huomiot","source":"LÃ¤hde: ","siteTitle":"ReseptikÃ¤Ã¤ntÃ¤jÃ¤","titlePart1":"Resepti","titlePart2":"kÃ¤Ã¤ntÃ¤jÃ¤","ttsPlay":"Lue resepti Ã¤Ã¤neen","ttsPause":"Tauko","ttsResume":"Jatka","ttsStop":"Lopeta","ttsOf":"/","ttsIngHeading":"Aineosat","ttsStepWord":"Vaihe","ttsRead":"Lue Ã¤Ã¤neen","ttsIngHeader":"Aineosat","ttsStepsHeader":"Vaihe","ttsTitle":"Otsikko","ttsNotes":"Huomiot"},"de":{"langName":"Deutsch","subtitle":"RezeptÃ¼bersetzung & MaÃŸumrechnung","infoBtn":"Info","infoTitle":"Ãœber den RezeptÃ¼bersetzer","infoWelcome":"Willkommen beim RezeptÃ¼bersetzer!","infoP1":"Hier kannst du ein Rezept von einer beliebigen Sprache in eine andere Ã¼bersetzen.","infoP2":"WÃ¤hle, ob du aus eingefÃ¼gtem Text, Ã¼ber eine Webadresse (URL) oder durch Fotografieren einer Kochbuchseite Ã¼bersetzen mÃ¶chtest.","infoP3":"WÃ¤hle auch, ob du MaÃŸe in metrischen Einheiten (Standard) oder in Imperial Units haben mÃ¶chtest.","infoFooter":"Beachte, dass dies ein reiner Ãœbersetzungsdienst ist und die Ãœbersetzung nur fÃ¼r den privaten Gebrauch verwendet werden darf.","tabText":"Text einfÃ¼gen","tabUrl":"Webadresse (URL)","tabImg":"Foto ğŸ“·","toLang":"Ãœbersetzen nach","fromLang":"Originalsprache","autoDetect":"Automatische Erkennung","unitsLabel":"MaÃŸeinheiten","metric":"Metrisch (dl, g, Â°C)","imperial":"Imperial (cups, oz, Â°F)","pasteLabel":"Originalrezept â€” beliebige Sprache","clear":"Leeren","urlLabel":"Webadresse des Rezepts","worksWith":"Funktioniert mit:","imgSlotFirst":"Foto tippen oder ablegen","imgSlotAdd":"Foto hinzufÃ¼gen","imgFormat":"JPG Â· PNG Â· HEIC Â· Max 1200Ã—1200px","imgCount1":" von ","imgCount2":" Fotos hinzugefÃ¼gt","imgCountMore":" â€” weitere mÃ¶glich","imgTipLabel":"Tipp: ","imgTip":"Funktioniert mit Kochbuchseiten, handgeschriebenen Rezepten und Speisekarten â€” in jeder Sprache. Lade mehrere Fotos hoch, wenn das Rezept lÃ¤nger ist.","converts":"Wird umgerechnet","btnTranslate":"Rezept Ã¼bersetzen","btnImg":"ğŸ“· Lesen & Ã¼bersetzen","copyBtn":"Text kopieren","copiedBtn":"âœ“ Kopiert","pdfBtn":"PDF herunterladen","resultFrom":"Ãœbersetztes Rezept â€” von","resultTo":"nach","resultPrefix":"Ãœbersetztes Rezept â€”","scaleLabel":"Skalieren:","ingredients":"Zutaten","steps":"Zubereitung","notes":"Tipps & Hinweise","source":"Quelle: ","siteTitle":"RezeptÃ¼bersetzer","titlePart1":"Rezept","titlePart2":"Ã¼bersetzer","ttsPlay":"Rezept vorlesen","ttsPause":"Pause","ttsResume":"Weiter","ttsStop":"Stopp","ttsOf":"von","ttsIngHeading":"Zutaten","ttsStepWord":"Schritt","ttsRead":"Vorlesen","ttsIngHeader":"Zutaten","ttsStepsHeader":"Schritt","ttsTitle":"Titel","ttsNotes":"Hinweise"},"fr":{"langName":"FranÃ§ais","subtitle":"Traduction de recettes & conversion des mesures","infoBtn":"Ã€ propos","infoTitle":"Ã€ propos du Traducteur de recettes","infoWelcome":"Bienvenue sur le Traducteur de recettes !","infoP1":"Ici, vous pouvez traduire une recette de n'importe quelle langue vers une autre langue.","infoP2":"Choisissez si vous souhaitez traduire depuis un texte collÃ©, une adresse web (URL) ou en photographiant une page de livre de cuisine.","infoP3":"Choisissez Ã©galement si vous souhaitez les mesures en unitÃ©s mÃ©triques (par dÃ©faut) ou en unitÃ©s impÃ©riales.","infoFooter":"N'oubliez pas que ce service est un outil de traduction et que vous ne pouvez l'utiliser qu'Ã  des fins personnelles.","tabText":"Coller du texte","tabUrl":"Adresse web (URL)","tabImg":"Photo ğŸ“·","toLang":"Traduire en","fromLang":"Langue originale","autoDetect":"DÃ©tection automatique","unitsLabel":"UnitÃ©s de mesure","metric":"MÃ©triques (dl, g, Â°C)","imperial":"ImpÃ©riales (cups, oz, Â°F)","pasteLabel":"Recette originale â€” langue quelconque","clear":"Effacer","urlLabel":"Adresse web de la recette","worksWith":"Fonctionne avec :","imgSlotFirst":"Appuyez ou dÃ©posez une photo ici","imgSlotAdd":"Ajouter une photo","imgFormat":"JPG Â· PNG Â· HEIC Â· Max 1200Ã—1200px","imgCount1":" sur ","imgCount2":" photos ajoutÃ©es","imgCountMore":" â€” vous pouvez en ajouter","imgTipLabel":"Conseil : ","imgTip":"Fonctionne avec des pages de livres de cuisine, des recettes manuscrites et des menus â€” dans n'importe quelle langue. TÃ©lÃ©chargez plusieurs photos si la recette est plus longue.","converts":"Conversions","btnTranslate":"Traduire la recette","btnImg":"ğŸ“· Lire & traduire","copyBtn":"Copier le texte","copiedBtn":"âœ“ CopiÃ©","pdfBtn":"TÃ©lÃ©charger PDF","resultFrom":"Recette traduite â€” de","resultTo":"en","resultPrefix":"Recette traduite â€”","scaleLabel":"Ã‰chelle :","ingredients":"IngrÃ©dients","steps":"PrÃ©paration","notes":"Conseils & remarques","source":"Source : ","siteTitle":"Traducteur de recettes","titlePart1":"Traducteur de ","titlePart2":"recettes","ttsPlay":"Lire la recette","ttsPause":"Pause","ttsResume":"Reprendre","ttsStop":"ArrÃªter","ttsOf":"sur","ttsIngHeading":"IngrÃ©dients","ttsStepWord":"Ã‰tape","ttsRead":"Lire","ttsIngHeader":"IngrÃ©dients","ttsStepsHeader":"Ã‰tape","ttsTitle":"Titre","ttsNotes":"Remarques"},"es":{"langName":"EspaÃ±ol","subtitle":"TraducciÃ³n de recetas & conversiÃ³n de medidas","infoBtn":"Acerca de","infoTitle":"Acerca del Traductor de recetas","infoWelcome":"Â¡Bienvenido al Traductor de recetas!","infoP1":"AquÃ­ puedes traducir una receta de cualquier idioma a otro idioma.","infoP2":"Elige si quieres traducir desde texto pegado, una direcciÃ³n web (URL) o fotografiando una pÃ¡gina de un libro de cocina.","infoP3":"TambiÃ©n elige si quieres las medidas en unidades mÃ©tricas (predeterminado) o en unidades imperiales.","infoFooter":"Recuerda que el Traductor de recetas es un servicio de traducciÃ³n puro y que solo puedes usarlo para uso privado.","tabText":"Pegar texto","tabUrl":"DirecciÃ³n web (URL)","tabImg":"Foto ğŸ“·","toLang":"Traducir a","fromLang":"Idioma original","autoDetect":"DetecciÃ³n automÃ¡tica","unitsLabel":"Unidades de medida","metric":"MÃ©tricas (dl, g, Â°C)","imperial":"Imperial (cups, oz, Â°F)","pasteLabel":"Receta original â€” cualquier idioma","clear":"Borrar","urlLabel":"DirecciÃ³n web de la receta","worksWith":"Funciona con:","imgSlotFirst":"Toca o arrastra una foto aquÃ­","imgSlotAdd":"AÃ±adir foto","imgFormat":"JPG Â· PNG Â· HEIC Â· MÃ¡x. 1200Ã—1200px","imgCount1":" de ","imgCount2":" fotos aÃ±adidas","imgCountMore":" â€” puedes aÃ±adir mÃ¡s","imgTipLabel":"Consejo: ","imgTip":"Funciona con pÃ¡ginas de libros de cocina, recetas escritas a mano y menÃºs â€” en cualquier idioma. Sube varias fotos si la receta es mÃ¡s larga.","converts":"Se convierte","btnTranslate":"Traducir receta","btnImg":"ğŸ“· Leer & traducir","copyBtn":"Copiar texto","copiedBtn":"âœ“ Copiado","pdfBtn":"Descargar PDF","resultFrom":"Receta traducida â€” de","resultTo":"a","resultPrefix":"Receta traducida â€”","scaleLabel":"Escala:","ingredients":"Ingredientes","steps":"PreparaciÃ³n","notes":"Consejos & notas","source":"Fuente: ","siteTitle":"Traductor de recetas","titlePart1":"Traductor de ","titlePart2":"recetas","ttsPlay":"Leer receta","ttsPause":"Pausa","ttsResume":"Reanudar","ttsStop":"Detener","ttsOf":"de","ttsIngHeading":"Ingredientes","ttsStepWord":"Paso","ttsRead":"Leer","ttsIngHeader":"Ingredientes","ttsStepsHeader":"Paso","ttsTitle":"TÃ­tulo","ttsNotes":"Notas"},"it":{"langName":"Italiano","subtitle":"Traduzione di ricette & conversione delle misure","infoBtn":"Info","infoTitle":"Informazioni sul Traduttore di ricette","infoWelcome":"Benvenuto nel Traduttore di ricette!","infoP1":"Qui puoi tradurre una ricetta da qualsiasi lingua in un'altra lingua.","infoP2":"Scegli se tradurre da testo incollato, inserendo un indirizzo web (URL) o fotografando una pagina di un libro di cucina.","infoP3":"Scegli anche se vuoi le misure in unitÃ  metriche (predefinite) o in unitÃ  imperiali.","infoFooter":"Ricorda che il Traduttore di ricette Ã¨ un servizio di traduzione puro e che puoi utilizzarlo solo per uso privato.","tabText":"Incolla testo","tabUrl":"Indirizzo web (URL)","tabImg":"Foto ğŸ“·","toLang":"Traduci in","fromLang":"Lingua originale","autoDetect":"Rilevamento automatico","unitsLabel":"UnitÃ  di misura","metric":"Metriche (dl, g, Â°C)","imperial":"Imperiali (cups, oz, Â°F)","pasteLabel":"Ricetta originale â€” qualsiasi lingua","clear":"Cancella","urlLabel":"Indirizzo web della ricetta","worksWith":"Funziona con:","imgSlotFirst":"Tocca o trascina una foto qui","imgSlotAdd":"Aggiungi foto","imgFormat":"JPG Â· PNG Â· HEIC Â· Max 1200Ã—1200px","imgCount1":" di ","imgCount2":" foto aggiunte","imgCountMore":" â€” puoi aggiungerne altre","imgTipLabel":"Suggerimento: ","imgTip":"Funziona con pagine di libri di cucina, ricette scritte a mano e menu â€” in qualsiasi lingua. Carica piÃ¹ foto se la ricetta Ã¨ piÃ¹ lunga.","converts":"Si converte","btnTranslate":"Traduci ricetta","btnImg":"ğŸ“· Leggi & traduci","copyBtn":"Copia testo","copiedBtn":"âœ“ Copiato","pdfBtn":"Scarica PDF","resultFrom":"Ricetta tradotta â€” da","resultTo":"in","resultPrefix":"Ricetta tradotta â€”","scaleLabel":"Scala:","ingredients":"Ingredienti","steps":"Preparazione","notes":"Consigli & note","source":"Fonte: ","siteTitle":"Traduttore di ricette","titlePart1":"Traduttore di ","titlePart2":"ricette","ttsPlay":"Leggi ricetta","ttsPause":"Pausa","ttsResume":"Riprendi","ttsStop":"Ferma","ttsOf":"di","ttsIngHeading":"Ingredienti","ttsStepWord":"Fase","ttsRead":"Leggi","ttsIngHeader":"Ingredienti","ttsStepsHeader":"Fase","ttsTitle":"Titolo","ttsNotes":"Note"},"nl":{"langName":"Nederlands","subtitle":"Receptvertaling & maateenheden omzetten","infoBtn":"Over","infoTitle":"Over de Receptvertaler","infoWelcome":"Welkom bij de Receptvertaler!","infoP1":"Hier kun je een recept van elke taal naar een andere taal vertalen.","infoP2":"Kies of je een recept wilt vertalen vanuit geplakte tekst, via een webadres (URL) of door een kookboekpagina te fotograferen.","infoP3":"Kies ook of je maten in metrische eenheden (standaard) of in imperial units wilt hebben.","infoFooter":"Onthoud dat de Receptvertaler een puur vertaalservice is en dat je het vertaalde recept alleen voor privÃ©gebruik mag gebruiken.","tabText":"Tekst plakken","tabUrl":"Webadres (URL)","tabImg":"Foto ğŸ“·","toLang":"Vertaal naar","fromLang":"Oorspronkelijke taal","autoDetect":"Automatische herkenning","unitsLabel":"Maateenheden","metric":"Metrisch (dl, g, Â°C)","imperial":"Imperiaal (cups, oz, Â°F)","pasteLabel":"Origineel recept â€” elke taal","clear":"Wissen","urlLabel":"Webadres van het recept","worksWith":"Werkt met:","imgSlotFirst":"Tik of sleep een foto hier naartoe","imgSlotAdd":"Foto toevoegen","imgFormat":"JPG Â· PNG Â· HEIC Â· Max 1200Ã—1200px","imgCount1":" van ","imgCount2":" foto's toegevoegd","imgCountMore":" â€” je kunt er meer toevoegen","imgTipLabel":"Tip: ","imgTip":"Werkt met kookboekpagina's, handgeschreven recepten en menu's â€” in elke taal. Upload meerdere foto's als het recept langer is.","converts":"Wordt omgezet","btnTranslate":"Recept vertalen","btnImg":"ğŸ“· Lezen & vertalen","copyBtn":"Tekst kopiÃ«ren","copiedBtn":"âœ“ Gekopieerd","pdfBtn":"PDF downloaden","resultFrom":"Vertaald recept â€” van","resultTo":"naar","resultPrefix":"Vertaald recept â€”","scaleLabel":"Schalen:","ingredients":"IngrediÃ«nten","steps":"Bereiding","notes":"Tips & opmerkingen","source":"Bron: ","siteTitle":"Receptvertaler","titlePart1":"Recept","titlePart2":"vertaler","ttsPlay":"Lees recept voor","ttsPause":"Pauze","ttsResume":"Doorgaan","ttsStop":"Stoppen","ttsOf":"van","ttsIngHeading":"IngrediÃ«nten","ttsStepWord":"Stap","ttsRead":"Lees voor","ttsIngHeader":"IngrediÃ«nten","ttsStepsHeader":"Stap","ttsTitle":"Titel","ttsNotes":"Opmerkingen"}};
const LANG_NAMES={"sv": {"Swedish": "svenska", "English": "engelska", "Danish": "danska", "Norwegian": "norska", "Finnish": "finska", "German": "tyska", "French": "franska", "Spanish": "spanska", "Italian": "italienska", "Dutch": "hollÃ¤ndska", "Portuguese": "portugisiska", "Polish": "polska", "Russian": "ryska", "Greek": "grekiska", "Turkish": "turkiska", "Japanese": "japanska", "Chinese": "kinesiska", "Korean": "koreanska", "Thai": "thai", "Arabic": "arabiska", "Hindi": "hindi"}, "en": {"Swedish": "Swedish", "English": "English", "Danish": "Danish", "Norwegian": "Norwegian", "Finnish": "Finnish", "German": "German", "French": "French", "Spanish": "Spanish", "Italian": "Italian", "Dutch": "Dutch", "Portuguese": "Portuguese", "Polish": "Polish", "Russian": "Russian", "Greek": "Greek", "Turkish": "Turkish", "Japanese": "Japanese", "Chinese": "Chinese", "Korean": "Korean", "Thai": "Thai", "Arabic": "Arabic", "Hindi": "Hindi"}, "da": {"Swedish": "svensk", "English": "engelsk", "Danish": "dansk", "Norwegian": "norsk", "Finnish": "finsk", "German": "tysk", "French": "fransk", "Spanish": "spansk", "Italian": "italiensk", "Dutch": "hollandsk", "Portuguese": "portugisisk", "Polish": "polsk", "Russian": "russisk", "Greek": "grÃ¦sk", "Turkish": "tyrkisk", "Japanese": "japansk", "Chinese": "kinesisk", "Korean": "koreansk", "Thai": "thai", "Arabic": "arabisk", "Hindi": "hindi"}, "no": {"Swedish": "svensk", "English": "engelsk", "Danish": "dansk", "Norwegian": "norsk", "Finnish": "finsk", "German": "tysk", "French": "fransk", "Spanish": "spansk", "Italian": "italiensk", "Dutch": "nederlandsk", "Portuguese": "portugisisk", "Polish": "polsk", "Russian": "russisk", "Greek": "gresk", "Turkish": "tyrkisk", "Japanese": "japansk", "Chinese": "kinesisk", "Korean": "koreansk", "Thai": "thai", "Arabic": "arabisk", "Hindi": "hindi"}, "fi": {"Swedish": "ruotsi", "English": "englanti", "Danish": "tanska", "Norwegian": "norja", "Finnish": "suomi", "German": "saksa", "French": "ranska", "Spanish": "espanja", "Italian": "italia", "Dutch": "hollanti", "Portuguese": "portugali", "Polish": "puola", "Russian": "venÃ¤jÃ¤", "Greek": "kreikka", "Turkish": "turkki", "Japanese": "japani", "Chinese": "kiina", "Korean": "korea", "Thai": "thai", "Arabic": "arabia", "Hindi": "hindi"}, "de": {"Swedish": "Schwedisch", "English": "Englisch", "Danish": "DÃ¤nisch", "Norwegian": "Norwegisch", "Finnish": "Finnisch", "German": "Deutsch", "French": "FranzÃ¶sisch", "Spanish": "Spanisch", "Italian": "Italienisch", "Dutch": "NiederlÃ¤ndisch", "Portuguese": "Portugiesisch", "Polish": "Polnisch", "Russian": "Russisch", "Greek": "Griechisch", "Turkish": "TÃ¼rkisch", "Japanese": "Japanisch", "Chinese": "Chinesisch", "Korean": "Koreanisch", "Thai": "Thaiisch", "Arabic": "Arabisch", "Hindi": "Hindi"}, "fr": {"Swedish": "suÃ©dois", "English": "anglais", "Danish": "danois", "Norwegian": "norvÃ©gien", "Finnish": "finnois", "German": "allemand", "French": "franÃ§ais", "Spanish": "espagnol", "Italian": "italien", "Dutch": "nÃ©erlandais", "Portuguese": "portugais", "Polish": "polonais", "Russian": "russe", "Greek": "grec", "Turkish": "turc", "Japanese": "japonais", "Chinese": "chinois", "Korean": "corÃ©en", "Thai": "thaÃ¯", "Arabic": "arabe", "Hindi": "hindi"}, "es": {"Swedish": "sueco", "English": "inglÃ©s", "Danish": "danÃ©s", "Norwegian": "noruego", "Finnish": "finlandÃ©s", "German": "alemÃ¡n", "French": "francÃ©s", "Spanish": "espaÃ±ol", "Italian": "italiano", "Dutch": "neerlandÃ©s", "Portuguese": "portuguÃ©s", "Polish": "polaco", "Russian": "ruso", "Greek": "griego", "Turkish": "turco", "Japanese": "japonÃ©s", "Chinese": "chino", "Korean": "coreano", "Thai": "tailandÃ©s", "Arabic": "Ã¡rabe", "Hindi": "hindi"}, "it": {"Swedish": "svedese", "English": "inglese", "Danish": "danese", "Norwegian": "norvegese", "Finnish": "finlandese", "German": "tedesco", "French": "francese", "Spanish": "spagnolo", "Italian": "italiano", "Dutch": "olandese", "Portuguese": "portoghese", "Polish": "polacco", "Russian": "russo", "Greek": "greco", "Turkish": "turco", "Japanese": "giapponese", "Chinese": "cinese", "Korean": "coreano", "Thai": "tailandese", "Arabic": "arabo", "Hindi": "hindi"}, "nl": {"Swedish": "Zweeds", "English": "Engels", "Danish": "Deens", "Norwegian": "Noors", "Finnish": "Fins", "German": "Duits", "French": "Frans", "Spanish": "Spaans", "Italian": "Italiaans", "Dutch": "Nederlands", "Portuguese": "Portugees", "Polish": "Pools", "Russian": "Russisch", "Greek": "Grieks", "Turkish": "Turks", "Japanese": "Japans", "Chinese": "Chinees", "Korean": "Koreaans", "Thai": "Thais", "Arabic": "Arabisch", "Hindi": "Hindi"}};



const LANG_TO_BCP47={"Swedish":"sv-SE","English":"en-US","Danish":"da-DK","Norwegian":"nb-NO",
"Finnish":"fi-FI","German":"de-DE","French":"fr-FR","Spanish":"es-ES","Italian":"it-IT",
"Dutch":"nl-NL","Portuguese":"pt-PT","Polish":"pl-PL","Russian":"ru-RU","Greek":"el-GR",
"Turkish":"tr-TR","Japanese":"ja-JP","Chinese":"zh-CN","Korean":"ko-KR",
"Thai":"th-TH","Arabic":"ar-SA","Hindi":"hi-IN"};

const UI_LANG_LIST=[
  {code:"sv",flag:"ğŸ‡¸ğŸ‡ª"},{code:"en",flag:"ğŸ‡¬ğŸ‡§"},{code:"da",flag:"ğŸ‡©ğŸ‡°"},{code:"no",flag:"ğŸ‡³ğŸ‡´"},
  {code:"fi",flag:"ğŸ‡«ğŸ‡®"},{code:"de",flag:"ğŸ‡©ğŸ‡ª"},{code:"fr",flag:"ğŸ‡«ğŸ‡·"},
  {code:"es",flag:"ğŸ‡ªğŸ‡¸"},{code:"it",flag:"ğŸ‡®ğŸ‡¹"},{code:"nl",flag:"ğŸ‡³ğŸ‡±"},
];

function detectUiLang(){
  const nav=(navigator.languages&&navigator.languages[0])||navigator.language||"sv";
  const code=nav.toLowerCase().split("-")[0];
  const map={"sv":"sv","en":"en","da":"da","no":"no","nb":"no","nn":"no","fi":"fi",
              "de":"de","fr":"fr","es":"es","it":"it","nl":"nl"};
  return map[code]||"sv";
}

// â”€â”€ PDF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pdfEncode(s){
  return String(s||"").replace(/\\/g,"\\\\").replace(/\(/g,"\\(").replace(/\)/g,"\\)")
    .split("").map(c=>{const n=c.charCodeAt(0);if(n<32)return" ";if(n>255)return"?";
    if(n>127)return"\\"+n.toString(8).padStart(3,"0");return c;}).join("");
}
function wrapText(text,fontSize){
  const max=Math.floor(495/(fontSize*0.55));
  const words=String(text||"").split(/\s+/).filter(Boolean);
  const lines=[];let line="";
  for(const w of words){const t=line?line+" "+w:w;if(t.length>max&&line){lines.push(line);line=w;}else line=t;}
  if(line)lines.push(line);return lines.length?lines:[""];
}
function generatePDF(recipe,T){
  const PW=595,PH=842,M=55;const items=[];
  const add=(text,size,bold,color,indent,sb)=>items.push({text:text||"",size:size||11,bold:!!bold,color:color||[30,30,30],indent:indent||0,spaceBefore:sb||0});
  add(recipe.titel||"Recept",20,true,[45,74,62],0,0);
  if(recipe.beskrivning)add(recipe.beskrivning,10,false,[107,98,88],0,8);
  const mt=recipe.meta||{};
  const ms=[mt.portioner,mt.totaltid&&"Totalt: "+mt.totaltid,mt.svarighetsgrad].filter(Boolean).join("   |   ");
  if(ms)add(ms,9,false,[130,120,110],0,6);
  add("",8);add(getRecipeLabels(recipe._tLang||"Swedish").ingredients,13,true,[184,92,56],0,4);
  let lg="";
  for(const ing of(recipe.ingredienser||[])){
    if(ing.grupp&&ing.grupp!==lg){add(ing.grupp.toUpperCase(),8,true,[107,98,88],0,8);lg=ing.grupp;}
    add("- "+(ing.mangd?ing.mangd+"   ":"")+(ing.ingrediens||""),10,false,[30,30,30],8,0);
  }
  add("",8);add(getRecipeLabels(recipe._tLang||"Swedish").steps,13,true,[184,92,56],0,4);
  (recipe.steg||[]).forEach((s,i)=>add((i+1)+".  "+s,10,false,[30,30,30],8,4));
  if(recipe.noteringar){add("",8);add(T.notes,11,true,[184,92,56],0,0);add(recipe.noteringar,10,false,[107,98,88],8,4);}
  const allOps=[];let pi=0,y=PH-M;
  for(const item of items){y-=item.spaceBefore;if(y<M){pi++;y=PH-M;}if(!item.text)continue;
    for(const line of wrapText(item.text,item.size)){const lh=item.size*1.5;if(y-lh<M){pi++;y=PH-M;}
      const col=item.color;allOps.push({pi,x:M+item.indent,y,text:pdfEncode(line),size:item.size,bold:item.bold,r:col[0],g:col[1],b:col[2]});y-=lh;}}
  const nP=pi+1;
  const streams=Array.from({length:nP},(_,p)=>allOps.filter(op=>op.pi===p).map(op=>{
    const r=(op.r/255).toFixed(3),g=(op.g/255).toFixed(3),b=(op.b/255).toFixed(3);
    return r+" "+g+" "+b+" rg\nBT\n/"+(op.bold?"F2":"F1")+" "+op.size+" Tf\n"+op.x+" "+op.y+" Td\n("+op.text+") Tj\nET\n";
  }).join(""));
  const pR=Array.from({length:nP},(_,p)=>(5+p*2)+" 0 R").join(" ");
  const objs={};
  objs[1]="<< /Type /Catalog /Pages 2 0 R >>";
  objs[2]="<< /Type /Pages /Kids ["+pR+"] /Count "+nP+" >>";
  objs[3]="<< /Type /Font /Subtype /Type1 /BaseFont /Helvetica /Encoding /WinAnsiEncoding >>";
  objs[4]="<< /Type /Font /Subtype /Type1 /BaseFont /Helvetica-Bold /Encoding /WinAnsiEncoding >>";
  for(let p=0;p<nP;p++){
    objs[5+p*2]="<< /Type /Page /Parent 2 0 R /MediaBox [0 0 "+PW+" "+PH+"]\n/Contents "+(6+p*2)+" 0 R\n/Resources << /Font << /F1 3 0 R /F2 4 0 R >> >> >>";
    objs[6+p*2]="<< /Length "+streams[p].length+" >>\nstream\n"+streams[p]+"\nendstream";}
  const tot=5+nP*2;let pdf="%PDF-1.4\n";const off={};
  for(let i=1;i<tot;i++){off[i]=pdf.length;pdf+=i+" 0 obj\n"+objs[i]+"\nendobj\n";}
  const xAt=pdf.length;pdf+="xref\n0 "+tot+"\n0000000000 65535 f \n";
  for(let i=1;i<tot;i++)pdf+=String(off[i]).padStart(10,"0")+" 00000 n \n";
  pdf+="trailer\n<< /Size "+tot+" /Root 1 0 R >>\nstartxref\n"+xAt+"\n%%EOF";
  const blob=new Blob([pdf],{type:"application/pdf"});const burl=URL.createObjectURL(blob);
  const a=document.createElement("a");a.href=burl;
  a.download=(recipe.titel||"recept").replace(/[^a-z0-9]/gi,"-").toLowerCase()+".pdf";
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(burl),1000);
}

// â”€â”€ Backend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function callBackend(payload){
  // HÃ¤mta ett kortlivat HMAC-token frÃ¥n servern precis innan anropet.
  // TOKEN_SECRET finns bara pÃ¥ servern â€” ingen hemlighet i HTML-kÃ¤llkoden.
  let token = null;
  try {
    const tr = await fetch("/api/token", { method: "GET", cache: "no-store" });
    const td = await tr.json();
    if (td.ok && td.token) token = td.token;
  } catch {}

  const reqBody = token ? { ...payload, token } : payload;
  const res=await fetch("/api/translate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(reqBody)});
  const data=await res.json();
  if(!data.ok)throw new Error(data.error||"Server error "+res.status);
  return data.recipe;
}

// â”€â”€ Portion scaling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function formatScaledNum(n){
  if(n<=0)return"0";
  const whole=Math.floor(n),frac=n-whole;
  const fracs=[[0.25,"Â¼"],[0.33,"â…“"],[0.5,"Â½"],[0.67,"â…”"],[0.75,"Â¾"]];
  for(const [v,s] of fracs){if(Math.abs(frac-v)<0.07)return whole>0?whole+" "+s:s;}
  if(Math.abs(n-Math.round(n))<0.05)return String(Math.round(n));
  return (Math.round(n*10)/10).toString().replace(".",",");
}
function scaleAmount(mangd,factor){
  if(!mangd||factor===1)return mangd;
  return mangd.replace(/\d+(?:[.,]\d+)?(?:\/\d+)?/g,(m)=>{
    let val;
    if(m.includes("/")){const p=m.split("/");val=parseFloat(p[0])/parseFloat(p[1]);}
    else val=parseFloat(m.replace(",","."));
    if(isNaN(val))return m;
    return formatScaledNum(val*factor);
  });
}
function scalePortioner(str,factor){
  if(!str)return str;
  return str.replace(/\d+/,n=>Math.round(parseInt(n)*factor));
}
function buildPlainText(result,srcUrl,scale,T){
  const m=result.meta||{};
  let t=(result.titel||"")+"\n";
  if(result.beskrivning)t+=result.beskrivning+"\n";
  const port=scale!==1&&m.portioner?scalePortioner(m.portioner,scale):m.portioner;
  [port,m.totaltid,m.svarighetsgrad].filter(Boolean).forEach(v=>t+=v+"   ");
  t+="\n\n"+getRecipeLabels(result._tLang||tLang).ingredients.toUpperCase()+"\n";let lg="";
  for(const i of(result.ingredienser||[])){
    if(i.grupp&&i.grupp!==lg){t+="\n"+i.grupp.toUpperCase()+"\n";lg=i.grupp;}
    t+="- "+(i.mangd?scaleAmount(i.mangd,scale)+"  ":"")+(i.ingrediens||"")+"\n";
  }
  t+="\n"+getRecipeLabels(result._tLang||tLang).steps.toUpperCase()+"\n";
  (result.steg||[]).forEach((s,i)=>{t+=(i+1)+". "+s+"\n";});
  if(result.noteringar)t+="\n"+T.notes.toUpperCase()+"\n"+result.noteringar;
  if(srcUrl)t+="\n\n"+T.source+srcUrl;
  return t.trim();
}

// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const F="#2d4a3e",T2="#b85c38",G="#c9a84c",CR="#f5f0e8",PA="#ede6d6",WA="#faf7f2",MI="#6b6258",BO="#d4c9b5";
const LANGS=["Swedish","English","Danish","Norwegian","Finnish","German","French","Spanish","Italian","Dutch","Portuguese","Polish","Russian","Greek","Turkish","Japanese","Chinese","Korean","Thai","Arabic","Hindi"];
// Labels used inside the recipe result â€” must follow TARGET language, not UI language
const RECIPE_LABELS={
  "Swedish":   {ingredients:"Ingredienser",  steps:"GÃ¶r sÃ¥ hÃ¤r",       stepWord:"Steg"},
  "English":   {ingredients:"Ingredients",   steps:"Instructions",     stepWord:"Step"},
  "Danish":    {ingredients:"Ingredienser",  steps:"SÃ¥dan gÃ¸r du",     stepWord:"Trin"},
  "Norwegian": {ingredients:"Ingredienser",  steps:"Slik gjÃ¸r du det", stepWord:"Trinn"},
  "Finnish":   {ingredients:"Ainesosat",     steps:"Valmistus",        stepWord:"Vaihe"},
  "German":    {ingredients:"Zutaten",       steps:"Zubereitung",      stepWord:"Schritt"},
  "French":    {ingredients:"IngrÃ©dients",   steps:"PrÃ©paration",      stepWord:"Ã‰tape"},
  "Spanish":   {ingredients:"Ingredientes",  steps:"PreparaciÃ³n",      stepWord:"Paso"},
  "Italian":   {ingredients:"Ingredienti",   steps:"Preparazione",     stepWord:"Fase"},
  "Dutch":     {ingredients:"IngrediÃ«nten",  steps:"Bereiding",        stepWord:"Stap"},
  "Portuguese":{ingredients:"Ingredientes",  steps:"Modo de preparo",  stepWord:"Passo"},
  "Polish":    {ingredients:"SkÅ‚adniki",     steps:"Przygotowanie",    stepWord:"Krok"},
  "Russian":   {ingredients:"Ğ˜Ğ½Ğ³Ñ€ĞµĞ´Ğ¸ĞµĞ½Ñ‚Ñ‹",   steps:"ĞŸÑ€Ğ¸Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ",    stepWord:"Ğ¨Ğ°Ğ³"},
  "Greek":     {ingredients:"Î¥Î»Î¹ÎºÎ¬",         steps:"Î Î±ÏÎ±ÏƒÎºÎµÏ…Î®",        stepWord:"Î’Î®Î¼Î±"},
  "Turkish":   {ingredients:"Malzemeler",    steps:"HazÄ±rlanÄ±ÅŸÄ±",      stepWord:"AdÄ±m"},
  "Japanese":  {ingredients:"ææ–™",           steps:"ä½œã‚Šæ–¹",            stepWord:"æ‰‹é †"},
  "Chinese":   {ingredients:"é£Ÿæ",           steps:"åšæ³•",              stepWord:"æ­¥éª¤"},
  "Korean":    {ingredients:"ì¬ë£Œ",           steps:"ë§Œë“œëŠ” ë²•",         stepWord:"ë‹¨ê³„"},
  "Thai":      {ingredients:"à¸ªà¹ˆà¸§à¸™à¸œà¸ªà¸¡",        steps:"à¸§à¸´à¸˜à¸µà¸—à¸³",            stepWord:"à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™"},
  "Arabic":    {ingredients:"Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª",       steps:"Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ­Ø¶ÙŠØ±",    stepWord:"Ø®Ø·ÙˆØ©"},
  "Hindi":     {ingredients:"à¤¸à¤¾à¤®à¤—à¥à¤°à¥€",         steps:"à¤µà¤¿à¤§à¤¿",              stepWord:"à¤šà¤°à¤£"},
};
function getRecipeLabels(lang){ return RECIPE_LABELS[lang]||RECIPE_LABELS["English"]; }
const SS={padding:"7px 10px",border:"1px solid #d4c9b5",borderRadius:5,fontFamily:"Georgia,serif",fontSize:13,color:"#2a2a2a",background:"#f5f0e8",outline:"none",cursor:"pointer",width:"100%"};
const MAX_IMGS=4;
const EXAMPLE=`Chocolate Chip Cookies (24 cookies)
350 degrees F, 10-12 minutes

2 1/4 cups flour
1 cup (2 sticks) butter, softened
3/4 cup granulated sugar
3/4 cup brown sugar
2 large eggs
1 tsp vanilla extract
1 tsp baking soda, 1 tsp salt
2 cups chocolate chips

Beat butter and sugars until fluffy. Add eggs and vanilla.
Mix in flour, baking soda, and salt. Stir in chips.
Drop by rounded tablespoon onto ungreased baking sheets.
Bake 9-11 minutes until golden brown. Cool on wire rack.`;

// â”€â”€ SVG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function SumiIllustration(){
  const svg = `<svg viewBox="0 0 1200 300" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:auto;display:block;">
  <defs>
    <!-- Felt texture for puppet skin -->
    <filter id="felt" x="-5%" y="-5%" width="110%" height="110%" color-interpolation-filters="sRGB">
      <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="4" seed="2" result="noise"/>
      <feColorMatrix type="saturate" values="0" in="noise" result="grayNoise"/>
      <feComposite in="SourceGraphic" in2="grayNoise" operator="arithmetic" k1="0" k2="0.88" k3="0.14" k4="0"/>
    </filter>
    <!-- Felt for white/coat areas -->
    <filter id="feltWhite" x="-5%" y="-5%" width="110%" height="110%" color-interpolation-filters="sRGB">
      <feTurbulence type="fractalNoise" baseFrequency="1.1" numOctaves="4" seed="7" result="noise"/>
      <feColorMatrix type="saturate" values="0" in="noise" result="grayNoise"/>
      <feComposite in="SourceGraphic" in2="grayNoise" operator="arithmetic" k1="0" k2="0.92" k3="0.09" k4="0"/>
    </filter>
    <!-- Mustache felt â€” cream colored, more pronounced texture -->
    <filter id="feltMust" x="-8%" y="-8%" width="116%" height="116%" color-interpolation-filters="sRGB">
      <feTurbulence type="fractalNoise" baseFrequency="0.65" numOctaves="5" seed="12" result="noise"/>
      <feColorMatrix type="saturate" values="0" in="noise" result="grayNoise"/>
      <feComposite in="SourceGraphic" in2="grayNoise" operator="arithmetic" k1="0" k2="0.82" k3="0.2" k4="0"/>
    </filter>
    <!-- Soft glow -->
    <filter id="glow">
      <feGaussianBlur stdDeviation="6" result="blur"/>
      <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>
    <!-- Drop shadow -->
    <filter id="shad">
      <feDropShadow dx="5" dy="8" stdDeviation="10" flood-color="rgba(0,0,0,0.5)"/>
    </filter>
    <filter id="shadSm">
      <feDropShadow dx="2" dy="3" stdDeviation="5" flood-color="rgba(0,0,0,0.35)"/>
    </filter>
    <filter id="blr">
      <feGaussianBlur stdDeviation="4"/>
    </filter>
    <!-- Kitchen bg gradient -->
    <linearGradient id="kitchenBg" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#6b4e2a"/>
      <stop offset="60%" stop-color="#8b6535"/>
      <stop offset="100%" stop-color="#4a3018"/>
    </linearGradient>
    <radialGradient id="spotLight" cx="50%" cy="25%" r="55%">
      <stop offset="0%" stop-color="#d4a855" stop-opacity="0.35"/>
      <stop offset="100%" stop-color="#6b4e2a" stop-opacity="0"/>
    </radialGradient>
    <!-- Face gradient - muppet felt peach/pink -->
    <radialGradient id="faceGrad" cx="44%" cy="36%" r="58%">
      <stop offset="0%" stop-color="#e8a878"/>
      <stop offset="55%" stop-color="#d4885a"/>
      <stop offset="100%" stop-color="#b86838"/>
    </radialGradient>
    <!-- Eyeball gradient -->
    <radialGradient id="eyeGrad" cx="38%" cy="35%" r="60%">
      <stop offset="0%" stop-color="#f0ece4"/>
      <stop offset="100%" stop-color="#d8d0c4"/>
    </radialGradient>
    <clipPath id="sc"><rect width="1200" height="300"/></clipPath>
  </defs>

  <g clip-path="url(#sc)">

  <!-- â•â•â• KITCHEN BACKGROUND â•â•â• -->
  <rect width="1200" height="300" fill="url(#kitchenBg)"/>
  <rect width="1200" height="300" fill="url(#spotLight)"/>

  <!-- Wooden paneling horizontal lines -->
  <g stroke="#5a3c1a" stroke-width="1.5" opacity="0.4">
    <line x1="0" y1="75" x2="1200" y2="75"/>
    <line x1="0" y1="150" x2="1200" y2="150"/>
    <line x1="0" y1="225" x2="1200" y2="225"/>
  </g>
  <!-- Wood grain dots/knots -->
  <g fill="#4a3018" opacity="0.2">
    <ellipse cx="80" cy="110" rx="18" ry="10" transform="rotate(-8,80,110)"/>
    <ellipse cx="340" cy="55" rx="14" ry="7" transform="rotate(5,340,55)"/>
    <ellipse cx="900" cy="188" rx="16" ry="8" transform="rotate(-4,900,188)"/>
    <ellipse cx="1100" cy="80" rx="12" ry="6" transform="rotate(6,1100,80)"/>
  </g>

  <!-- Countertop -->
  <rect x="0" y="255" width="1200" height="45" fill="#5a3c1a"/>
  <rect x="0" y="253" width="1200" height="6" fill="#7a5830" opacity="0.8"/>

  <!-- â•â•â• LEFT SIDE CHAOS â•â•â• -->

  <!-- Flying ingredients - loose vegetables -->
  <!-- Potato tumbling -->
  <g transform="rotate(18, 140, 105)" filter="url(#shadSm)">
    <ellipse cx="140" cy="105" rx="42" ry="35" fill="#c8a858"/>
    <ellipse cx="140" cy="105" rx="42" ry="35" fill="none" stroke="#9a7830" stroke-width="2"/>
    <ellipse cx="128" cy="96" rx="10" ry="8" fill="#b09040" opacity="0.4"/>
    <circle cx="155" cy="108" r="5" fill="#9a7830" opacity="0.45"/>
    <circle cx="132" cy="116" r="4" fill="#9a7830" opacity="0.35"/>
  </g>

  <!-- Herring fish - classic Swedish -->
  <g transform="rotate(-18, 255, 72)" filter="url(#shadSm)">
    <path d="M182,62 Q218,44 270,54 Q316,64 335,80 Q316,96 270,100 Q218,104 182,86 Z" fill="#7090a8"/>
    <path d="M182,62 Q162,52 154,42 Q164,64 154,86 Q162,76 182,86 Z" fill="#6080a0"/>
    <!-- Fish eye -->
    <circle cx="320" cy="76" r="9" fill="white"/>
    <circle cx="322" cy="75" r="5" fill="#1a2830"/>
    <circle cx="324" cy="73" r="2" fill="white"/>
    <!-- Scales -->
    <g fill="none" stroke="#5070a0" stroke-width="1.2" opacity="0.45">
      <path d="M224,60 Q234,54 244,60"/><path d="M244,56 Q254,50 264,56"/>
      <path d="M222,72 Q232,66 242,72"/><path d="M242,68 Q252,62 262,68"/>
      <path d="M220,84 Q230,78 240,84"/>
    </g>
  </g>

  <!-- Rolling pin - chaotic angle -->
  <g transform="rotate(-30, 285, 190)" filter="url(#shadSm)">
    <rect x="200" y="182" width="38" height="19" rx="9.5" fill="#c9a050" stroke="#8a6820" stroke-width="2"/>
    <rect x="238" y="176" width="160" height="26" rx="13" fill="#e8d8a8" stroke="#b89848" stroke-width="2"/>
    <g stroke="#c8b888" stroke-width="1" opacity="0.4">
      <line x1="268" y1="177" x2="268" y2="201"/><line x1="298" y1="177" x2="298" y2="201"/>
      <line x1="328" y1="177" x2="328" y2="201"/><line x1="358" y1="177" x2="358" y2="201"/>
    </g>
    <rect x="398" y="182" width="38" height="19" rx="9.5" fill="#c9a050" stroke="#8a6820" stroke-width="2"/>
  </g>

  <!-- Splash of something liquid, top left -->
  <g fill="#c84820" opacity="0.75" filter="url(#shadSm)">
    <path d="M62,28 Q68,8 80,22 L88,48 Q72,50 62,28 Z"/>
    <path d="M80,22 Q94,4 104,20 L106,46 L88,48 Z"/>
    <path d="M104,20 Q112,6 120,22 L118,46 L106,46 Z"/>
    <path d="M68,50 L88,48 L106,46 L118,46 Q110,62 88,64 Q72,62 68,50 Z"/>
    <circle cx="64" cy="72" r="7"/>
    <circle cx="55" cy="54" r="5"/>
    <circle cx="122" cy="74" r="6"/>
  </g>

  <!-- Motion lines top left -->
  <g stroke="#c9a84c" stroke-linecap="round" opacity="0.4">
    <line x1="30" y1="100" x2="70" y2="95" stroke-width="3"/>
    <line x1="24" y1="118" x2="62" y2="115" stroke-width="2.5"/>
    <line x1="28" y1="136" x2="64" y2="134" stroke-width="2"/>
  </g>

  <!-- â•â•â• RIGHT SIDE CHAOS â•â•â• -->

  <!-- Flying saucepan -->
  <g transform="rotate(25, 978, 88)" filter="url(#shadSm)">
    <!-- Handle -->
    <rect x="868" y="76" width="124" height="20" rx="10" fill="#2e2820" stroke="#484030" stroke-width="1.5"/>
    <!-- Pan body -->
    <path d="M986,34 L998,136 Q998,148 986,148 L898,148 Q886,148 886,136 L898,34 Z" fill="#3a3428"/>
    <path d="M886,34 L1000,34 Q1002,22 994,18 L892,18 Q884,22 886,34 Z" fill="#4a4438"/>
    <!-- Content: sauce bubbling -->
    <ellipse cx="942" cy="94" rx="50" ry="45" fill="#b84020" opacity="0.88"/>
    <circle cx="925" cy="80" r="10" fill="#e06040" opacity="0.6"/>
    <circle cx="958" cy="108" r="8" fill="#e06040" opacity="0.5"/>
    <circle cx="935" cy="110" r="6" fill="#e06040" opacity="0.45"/>
  </g>

  <!-- Sauce splatter right wall -->
  <g fill="#b84020" opacity="0.65">
    <circle cx="1078" cy="44" r="14"/>
    <circle cx="1096" cy="76" r="10"/>
    <circle cx="1068" cy="86" r="8"/>
    <path d="M1078,58 Q1082,68 1078,82" stroke="#b84020" stroke-width="7" fill="none" stroke-linecap="round"/>
    <circle cx="1112" cy="38" r="9"/>
    <circle cx="1130" cy="62" r="12"/>
    <path d="M1130,74 Q1134,86 1130,100" stroke="#b84020" stroke-width="6" fill="none" stroke-linecap="round"/>
    <circle cx="1130" cy="104" r="7"/>
    <circle cx="1148" cy="122" r="5"/>
    <circle cx="1058" cy="110" r="6"/>
  </g>

  <!-- Meatballs arc trajectory -->
  <g filter="url(#shadSm)">
    <circle cx="1060" cy="180" r="26" fill="#7a3818" stroke="#5a2410" stroke-width="2"/>
    <ellipse cx="1052" cy="172" rx="8" ry="7" fill="#9a4828" opacity="0.5"/>
    <circle cx="1115" cy="136" r="20" fill="#7a3818" stroke="#5a2410" stroke-width="1.5"/>
    <circle cx="1155" cy="172" r="16" fill="#7a3818" stroke="#5a2410" stroke-width="1.5"/>
  </g>
  <path d="M1060,180 Q1088,158 1115,136" fill="none" stroke="#9a4828" stroke-width="2" stroke-dasharray="5,7" opacity="0.5"/>
  <path d="M1115,136 Q1135,154 1155,172" fill="none" stroke="#9a4828" stroke-width="2" stroke-dasharray="5,7" opacity="0.5"/>

  <!-- Onion bouncing -->
  <g transform="translate(796, 228) rotate(15)" filter="url(#shadSm)">
    <ellipse cx="0" cy="0" rx="35" ry="38" fill="#f0e8b8" stroke="#c8bc80" stroke-width="1.5"/>
    <path d="M-20,-30 Q0,-52 20,-30" fill="#4a8030" stroke="#2a5818" stroke-width="1.5"/>
    <path d="M-10,-32 Q0,-48 10,-32" fill="#6aaa50" stroke="#2a5818" stroke-width="1"/>
    <g fill="none" stroke="#c8bc80" stroke-width="1.2" opacity="0.5">
      <path d="M-28,-8 Q0,6 28,-8"/><path d="M-30,6 Q0,20 30,6"/>
      <path d="M-26,-20 Q0,-8 26,-20"/>
    </g>
  </g>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- THE CHEF - MUPPET PUPPET STYLE -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <g filter="url(#shad)">

  <!-- CHEF COAT - white felt with puppet proportions -->
  <g filter="url(#feltWhite)">
    <path d="M468,300 Q458,228 484,196
             L516,178 L684,178 L716,196
             Q742,228 732,300 Z"
          fill="#f0eee8" stroke="#d8d4cc" stroke-width="2"/>
  </g>
  <!-- Coat shading -->
  <path d="M468,300 Q458,228 484,196 L516,178 L530,192 Q506,226 512,300 Z" fill="#d8d4cc" opacity="0.4"/>
  <!-- Double row buttons -->
  <g fill="#c9a84c" stroke="#8a6a18" stroke-width="1.5">
    <circle cx="558" cy="210" r="8"/><circle cx="558" cy="238" r="8"/><circle cx="558" cy="266" r="8"/>
    <circle cx="642" cy="210" r="8"/><circle cx="642" cy="238" r="8"/><circle cx="642" cy="266" r="8"/>
  </g>
  <!-- Lapels -->
  <path d="M524,184 Q534,160 558,156 L600,172 L642,156 Q666,160 676,184 L600,196 Z"
        fill="#e8e4dc" stroke="#d0ccc4" stroke-width="1.5" filter="url(#feltWhite)"/>
  <path d="M524,184 L554,156 L600,196 Z" fill="#d8d4cc" opacity="0.5"/>
  <path d="M676,184 L646,156 L600,196 Z" fill="#d8d4cc" opacity="0.5"/>
  <line x1="600" y1="178" x2="600" y2="300" stroke="#d0ccc4" stroke-width="1.5"/>

  <!-- LEFT ARM - thick muppet arm, raised, holding whisk -->
  <path d="M488,200 Q444,210 400,182 Q370,163 348,142"
        fill="none" stroke="#f0eee8" stroke-width="46" stroke-linecap="round" filter="url(#feltWhite)"/>
  <path d="M488,200 Q444,210 400,182 Q370,163 348,142"
        fill="none" stroke="#d8d4cc" stroke-width="50" stroke-linecap="round" opacity="0.35"/>
  <!-- Cuff -->
  <ellipse cx="344" cy="140" rx="26" ry="20" fill="#d8d4cc" stroke="#c0bcb4" stroke-width="2"
           transform="rotate(-25,344,140)" filter="url(#feltWhite)"/>
  <!-- Muppet hand - simple rounded -->
  <path d="M316,128 Q296,116 294,130 Q292,146 306,156
           Q324,166 344,158 Q364,148 360,130
           Q354,114 334,116 Z"
        fill="#c87840" stroke="#a85a28" stroke-width="2" filter="url(#felt)"/>
  <!-- Whisk in hand -->
  <g transform="rotate(-78, 275, 70)">
    <rect x="262" y="30" width="14" height="100" rx="7" fill="#6a4a18" stroke="#3a2808" stroke-width="1.5"/>
    <g stroke="#b09030" stroke-width="3.5" fill="none">
      <path d="M269,28 Q296,6 298,-18 Q294,-42 274,-42 Q256,-42 260,-18 Q264,6 269,28"/>
      <path d="M276,30 Q306,4 306,-22 Q300,-48 280,-48 Q262,-46 268,-22 Q272,4 276,30"/>
      <path d="M262,30 Q282,8 282,-16 Q276,-40 258,-40 Q242,-38 246,-16 Q250,8 262,30"/>
    </g>
    <ellipse cx="269" cy="30" rx="12" ry="6.5" fill="#b09030" stroke="#3a2808" stroke-width="1"/>
  </g>

  <!-- RIGHT ARM - raised high with wooden spoon -->
  <path d="M712,200 Q756,210 800,182 Q830,163 852,142"
        fill="none" stroke="#f0eee8" stroke-width="46" stroke-linecap="round" filter="url(#feltWhite)"/>
  <path d="M712,200 Q756,210 800,182 Q830,163 852,142"
        fill="none" stroke="#d8d4cc" stroke-width="50" stroke-linecap="round" opacity="0.35"/>
  <!-- Cuff -->
  <ellipse cx="856" cy="140" rx="26" ry="20" fill="#d8d4cc" stroke="#c0bcb4" stroke-width="2"
           transform="rotate(25,856,140)" filter="url(#feltWhite)"/>
  <!-- Hand -->
  <path d="M862,126 Q882,114 886,128 Q890,144 876,156
           Q858,166 840,158 Q820,148 826,130
           Q832,114 852,116 Z"
        fill="#c87840" stroke="#a85a28" stroke-width="2" filter="url(#felt)"/>
  <!-- Wooden spoon -->
  <g transform="rotate(75, 920, 75)">
    <rect x="908" y="28" width="14" height="102" rx="7" fill="#7a5020" stroke="#4a2e08" stroke-width="1.5"/>
    <ellipse cx="915" cy="22" rx="26" ry="19" fill="#9a6830" stroke="#4a2e08" stroke-width="2"/>
    <ellipse cx="915" cy="22" rx="17" ry="12" fill="#7a5020" opacity="0.45"/>
  </g>

  <!-- NECK -->
  <rect x="574" y="164" width="52" height="26" rx="13" fill="#c87840" stroke="#a85a28" stroke-width="1.5"
        filter="url(#felt)"/>

  <!-- HEAD - the heart of the puppet, very round, felt texture -->
  <g filter="url(#felt)">
    <ellipse cx="600" cy="100" rx="104" ry="98" fill="url(#faceGrad)" stroke="#a86030" stroke-width="3"/>
  </g>
  <!-- Felt texture layer 2 - slightly different seed -->
  <ellipse cx="600" cy="100" rx="104" ry="98" fill="none" stroke="#b87040" stroke-width="1" opacity="0.2" stroke-dasharray="3,12"/>

  <!-- Head shading - gives roundness -->
  <ellipse cx="560" cy="80" rx="50" ry="35" fill="#e8a870" opacity="0.22" filter="url(#blr)"/>
  <path d="M700,60 Q718,100 710,145" fill="none" stroke="#985820" stroke-width="20" stroke-linecap="round" opacity="0.15" filter="url(#blr)"/>
  <path d="M500,60 Q482,100 490,145" fill="none" stroke="#985820" stroke-width="20" stroke-linecap="round" opacity="0.12" filter="url(#blr)"/>

  <!-- Puppet chin definition -->
  <path d="M510,158 Q560,180 600,182 Q640,180 690,158" fill="none" stroke="#985820" stroke-width="3" opacity="0.25"/>

  <!-- CHEF HAT - tall, white felt, slightly droopy/worn -->
  <!-- Hat brim/band -->
  <g filter="url(#feltWhite)">
    <rect x="494" y="14" width="212" height="30" rx="7" fill="#e8e6de" stroke="#c8c4bc" stroke-width="2"/>
    <!-- Blue band - Swedish Chef signature -->
    <rect x="494" y="22" width="212" height="12" rx="3" fill="#2a4080" opacity="0.75"/>
    <!-- Hat body -->
    <path d="M504,18 Q498,2 502,-8 Q528,-24 600,-26 Q672,-24 698,-8 Q702,2 696,18 Z"
          fill="#f0eee8" stroke="#d8d4cc" stroke-width="2"/>
    <!-- Hat puff top - slightly irregular for puppet feel -->
    <path d="M518,0 Q524,-28 558,-36 Q600,-42 642,-36 Q676,-28 682,0 Q650,-16 600,-18 Q550,-16 518,0 Z"
          fill="#f0eee8" stroke="#d8d4cc" stroke-width="2"/>
  </g>
  <!-- Hat wrinkle lines -->
  <g stroke="#d0ccc4" stroke-width="1.2" opacity="0.5">
    <line x1="528" y1="16" x2="522" y2="-12"/>
    <line x1="552" y1="17" x2="548" y2="-22"/>
    <line x1="576" y1="18" x2="574" y2="-26"/>
    <line x1="600" y1="18" x2="600" y2="-28"/>
    <line x1="624" y1="18" x2="626" y2="-26"/>
    <line x1="648" y1="17" x2="652" y2="-22"/>
    <line x1="672" y1="16" x2="678" y2="-12"/>
  </g>

  <!-- â•â•â• THE EYES - ping-pong ball style â•â•â• -->
  <!-- The Swedish Chef has droopy, half-lidded eyes over round white balls -->

  <!-- Eye shadow/socket - dark felt recesses -->
  <ellipse cx="548" cy="92" rx="40" ry="36" fill="#8a4820" opacity="0.30" filter="url(#blr)"/>
  <ellipse cx="652" cy="92" rx="40" ry="36" fill="#8a4820" opacity="0.30" filter="url(#blr)"/>

  <!-- Eyeball whites - LARGE, round like ping-pong balls -->
  <g filter="url(#glow)">
    <circle cx="548" cy="94" r="34" fill="url(#eyeGrad)" stroke="#b08850" stroke-width="2.5"/>
    <circle cx="652" cy="94" r="34" fill="url(#eyeGrad)" stroke="#b08850" stroke-width="2.5"/>
  </g>

  <!-- Irises - pale blue (Swedish Chef has blue eyes) -->
  <circle cx="552" cy="98" r="20" fill="#4a6888"/>
  <circle cx="648" cy="96" r="20" fill="#4a6888"/>

  <!-- Pupils - large, round -->
  <circle cx="554" cy="100" r="12" fill="#0a0808"/>
  <circle cx="646" cy="98" r="12" fill="#0a0808"/>

  <!-- Eye gleam - oversized cartoon highlight -->
  <circle cx="560" cy="92" r="6.5" fill="white" opacity="0.95"/>
  <circle cx="654" cy="90" r="6.5" fill="white" opacity="0.95"/>
  <circle cx="548" cy="106" r="3" fill="white" opacity="0.5"/>
  <circle cx="640" cy="104" r="3" fill="white" opacity="0.5"/>

  <!-- HEAVY DROOPING EYELIDS - key Swedish Chef feature, felt colored -->
  <!-- Left eyelid - droopy, covers top 40% of eyeball -->
  <path d="M514,72 Q548,58 582,72 Q570,96 548,98 Q526,96 514,72 Z"
        fill="#c87840" stroke="#a86030" stroke-width="1.5" filter="url(#felt)"/>
  <!-- Eyelid crease/fold -->
  <path d="M518,74 Q548,62 578,74" fill="none" stroke="#985820" stroke-width="2.5" opacity="0.6"/>
  <!-- Eyelash suggestion left -->
  <g stroke="#3a1808" stroke-width="2.2" stroke-linecap="round" opacity="0.7">
    <line x1="520" y1="71" x2="512" y2="62"/><line x1="534" y1="64" x2="530" y2="54"/>
    <line x1="549" y1="60" x2="547" y2="50"/><line x1="564" y1="63" x2="566" y2="53"/>
    <line x1="578" y1="70" x2="584" y2="61"/>
  </g>

  <!-- Right eyelid - droopy -->
  <path d="M618,70 Q652,56 686,70 Q674,94 652,96 Q630,94 618,70 Z"
        fill="#c87840" stroke="#a86030" stroke-width="1.5" filter="url(#felt)"/>
  <path d="M622,72 Q652,60 682,72" fill="none" stroke="#985820" stroke-width="2.5" opacity="0.6"/>
  <g stroke="#3a1808" stroke-width="2.2" stroke-linecap="round" opacity="0.7">
    <line x1="622" y1="69" x2="614" y2="60"/><line x1="636" y1="62" x2="632" y2="52"/>
    <line x1="651" y1="58" x2="649" y2="48"/><line x1="666" y1="61" x2="668" y2="51"/>
    <line x1="680" y1="68" x2="686" y2="59"/>
  </g>

  <!-- HEAVY EYEBROWS - thick, expressive, swept upward on outer edge (alarm/chaos) -->
  <!-- Left brow -->
  <path d="M508,60 Q532,40 580,48" fill="none" stroke="#2a1008" stroke-width="18" stroke-linecap="round"/>
  <path d="M508,60 Q532,40 580,48" fill="none" stroke="#4a2818" stroke-width="10" stroke-linecap="round"/>
  <path d="M510,59 Q534,41 578,49" fill="none" stroke="#6a3820" stroke-width="3" stroke-linecap="round" opacity="0.4"/>
  <!-- Right brow -->
  <path d="M620,48 Q668,40 692,60" fill="none" stroke="#2a1008" stroke-width="18" stroke-linecap="round"/>
  <path d="M620,48 Q668,40 692,60" fill="none" stroke="#4a2818" stroke-width="10" stroke-linecap="round"/>
  <path d="M622,49 Q668,41 690,59" fill="none" stroke="#6a3820" stroke-width="3" stroke-linecap="round" opacity="0.4"/>

  <!-- NOSE - bulbous, round, center of face -->
  <g filter="url(#felt)">
    <circle cx="600" cy="120" r="24" fill="#c07038" stroke="#985020" stroke-width="2"/>
  </g>
  <circle cx="592" cy="113" r="9" fill="#d88848" opacity="0.45"/>
  <ellipse cx="590" cy="127" rx="7" ry="6" fill="#885028" opacity="0.55"/>
  <ellipse cx="611" cy="127" rx="7" ry="6" fill="#885028" opacity="0.55"/>

  <!-- Cheek puffiness / rosy blush -->
  <ellipse cx="520" cy="126" rx="30" ry="24" fill="#b84820" opacity="0.18" filter="url(#blr)"/>
  <ellipse cx="680" cy="126" rx="30" ry="24" fill="#b84820" opacity="0.18" filter="url(#blr)"/>

  <!-- â•â•â• THE MAGNIFICENT MOUSTACHE â•â•â• -->
  <!-- White/cream, ENORMOUS, drooping, hairy felt texture -->
  <!-- This covers the mouth entirely - typical Swedish Chef -->
  <g filter="url(#feltMust)">

  <!-- Main moustache mass - left side -->
  <path d="M575,140
           Q558,138 536,146
           Q508,158 480,180
           Q452,203 444,224
           Q438,242 450,252
           Q466,260 486,250
           Q512,236 534,214
           Q560,188 576,162
           Q580,154 578,146 Z"
        fill="#f8f4ec" stroke="#e0dcd0" stroke-width="1.5"/>

  <!-- Left wing lower volume -->
  <path d="M575,140 Q556,142 536,154
           Q510,168 488,192 Q466,216 458,236"
        fill="none" stroke="#e8e4dc" stroke-width="12" stroke-linecap="round" opacity="0.6"/>

  <!-- Left tip curl - tight upward curl -->
  <path d="M444,224 Q428,244 436,256 Q448,268 464,258 Q480,246 472,230 Q464,216 450,220 Z"
        fill="#f8f4ec" stroke="#e0dcd0" stroke-width="1.5"/>

  <!-- Right side - mirrored -->
  <path d="M625,140
           Q642,138 664,146
           Q692,158 720,180
           Q748,203 756,224
           Q762,242 750,252
           Q734,260 714,250
           Q688,236 666,214
           Q640,188 624,162
           Q620,154 622,146 Z"
        fill="#f8f4ec" stroke="#e0dcd0" stroke-width="1.5"/>

  <!-- Right wing lower volume -->
  <path d="M625,140 Q644,142 664,154
           Q690,168 712,192 Q734,216 742,236"
        fill="none" stroke="#e8e4dc" stroke-width="12" stroke-linecap="round" opacity="0.6"/>

  <!-- Right tip curl -->
  <path d="M756,224 Q772,244 764,256 Q752,268 736,258 Q720,246 728,230 Q736,216 750,220 Z"
        fill="#f8f4ec" stroke="#e0dcd0" stroke-width="1.5"/>

  <!-- Center bridge - connects across upper lip -->
  <path d="M578,146 Q588,134 600,132 Q612,134 622,146
           Q614,156 600,158 Q586,156 578,146 Z"
        fill="#f8f4ec" stroke="#e0dcd0" stroke-width="1.5"/>

  </g><!-- end feltMust -->

  <!-- Moustache hair texture strokes - gives it the puppet/fuzzy feel -->
  <g stroke="#d0ccbe" stroke-linecap="round" opacity="0.55">
    <!-- Left wing hairs -->
    <path d="M540,152 Q528,165 530,178" stroke-width="2"/>
    <path d="M520,166 Q506,180 509,196" stroke-width="1.8"/>
    <path d="M504,180 Q489,196 493,212" stroke-width="1.8"/>
    <path d="M488,198 Q472,214 476,230" stroke-width="1.8"/>
    <path d="M466,220 Q452,234 458,248" stroke-width="1.8"/>
    <path d="M556,148 Q546,158 550,170" stroke-width="1.5"/>
    <path d="M536,160 Q524,173 528,186" stroke-width="1.5"/>
    <path d="M514,178 Q500,194 505,208" stroke-width="1.5"/>
    <path d="M496,198 Q480,215 485,230" stroke-width="1.5"/>
    <path d="M474,218 Q458,232 463,248" stroke-width="1.5"/>
    <!-- Right wing hairs (mirrored) -->
    <path d="M660,152 Q672,165 670,178" stroke-width="2"/>
    <path d="M680,166 Q694,180 691,196" stroke-width="1.8"/>
    <path d="M696,180 Q711,196 707,212" stroke-width="1.8"/>
    <path d="M712,198 Q728,214 724,230" stroke-width="1.8"/>
    <path d="M734,220 Q748,234 742,248" stroke-width="1.8"/>
    <path d="M644,148 Q654,158 650,170" stroke-width="1.5"/>
    <path d="M664,160 Q676,173 672,186" stroke-width="1.5"/>
    <path d="M686,178 Q700,194 695,208" stroke-width="1.5"/>
    <path d="M704,198 Q720,215 715,230" stroke-width="1.5"/>
    <path d="M726,218 Q742,232 737,248" stroke-width="1.5"/>
    <!-- Center bridge hairs -->
    <path d="M585,142 Q586,152 584,160" stroke-width="1.5"/>
    <path d="M598,138 Q599,150 597,160" stroke-width="1.5"/>
    <path d="M612,142 Q612,152 614,160" stroke-width="1.5"/>
  </g>

  </g><!-- end chef shadow -->

  <!-- â•â•â• ENERGY / MOTION â•â•â• -->
  <!-- Chef arm energy lines -->
  <g stroke="#c9a84c" stroke-linecap="round" opacity="0.45">
    <line x1="328" y1="132" x2="296" y2="118" stroke-width="3"/>
    <line x1="332" y1="148" x2="298" y2="144" stroke-width="2.5"/>
    <line x1="338" y1="164" x2="308" y2="164" stroke-width="2"/>
    <line x1="868" y1="130" x2="902" y2="118" stroke-width="3"/>
    <line x1="864" y1="146" x2="898" y2="142" stroke-width="2.5"/>
    <line x1="860" y1="162" x2="892" y2="162" stroke-width="2"/>
  </g>

  </g><!-- clip -->
</svg>`;
  return h("div", {dangerouslySetInnerHTML:{__html:svg}, style:{lineHeight:0}});
}
// â”€â”€ Language picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function LangPicker({uiLang,setUiLang}){
  const [open,setOpen]=useState(false);
  const ref=useRef();
  useEffect(()=>{
    if(!open)return;
    const fn=e=>{if(ref.current&&!ref.current.contains(e.target))setOpen(false);};
    document.addEventListener("mousedown",fn);
    return()=>document.removeEventListener("mousedown",fn);
  },[open]);
  const cur=UI_LANG_LIST.find(l=>l.code===uiLang)||UI_LANG_LIST[0];
  const T=UI_STRINGS[uiLang];
  return h("div",{ref,style:{position:"relative",flexShrink:0}},
    h("button",{
      onClick:()=>setOpen(v=>!v),
      style:{background:"rgba(201,168,76,0.12)",border:"1.5px solid rgba(201,168,76,0.45)",borderRadius:7,padding:"6px 11px",color:G,fontSize:12,fontWeight:700,cursor:"pointer",display:"flex",alignItems:"center",gap:6,letterSpacing:"0.04em",fontFamily:"sans-serif"}
    },
      h("span",{style:{fontSize:16,lineHeight:1}},cur.flag),
      h("span",{style:{fontSize:11}},T.langName),
      h("span",{style:{fontSize:9,opacity:0.7}},open?"â–²":"â–¼")
    ),
    open && h("div",{style:{position:"absolute",top:"calc(100% + 6px)",right:0,background:WA,border:"1px solid "+BO,borderRadius:8,boxShadow:"0 8px 28px rgba(0,0,0,0.18)",zIndex:200,minWidth:170,overflow:"hidden"}},
      UI_LANG_LIST.map(l=>
        h("button",{
          key:l.code,
          className:"lang-opt",
          onClick:()=>{setUiLang(l.code);setOpen(false);},
          style:{display:"flex",alignItems:"center",gap:9,width:"100%",padding:"10px 15px",border:"none",background:l.code===uiLang?PA:"transparent",cursor:"pointer",fontFamily:"sans-serif",fontSize:13,color:F,textAlign:"left",fontWeight:l.code===uiLang?700:400}
        },
          h("span",{style:{fontSize:16}},l.flag),
          h("span",null,UI_STRINGS[l.code].langName)
        )
      )
    )
  );
}

// â”€â”€ LangBar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function LangBar({tab,tLang,setTLang,sLang,setSLang,mobile,T}){
  return h("div",{style:{display:"grid",gridTemplateColumns:mobile?"1fr":"1fr 1fr",gap:12,marginBottom:16}},
    h("div",null,
      h("label",{style:{display:"block",fontFamily:"sans-serif",fontSize:9,fontWeight:700,letterSpacing:"0.15em",textTransform:"uppercase",color:MI,marginBottom:5}},T.toLang),
      h("select",{value:tLang,onChange:e=>setTLang(e.target.value),style:SS},
        LANGS.map(l=>h("option",{key:l,value:l},l)))
    ),
    tab!=="image"&&h("div",null,
      h("label",{style:{display:"block",fontFamily:"sans-serif",fontSize:9,fontWeight:700,letterSpacing:"0.15em",textTransform:"uppercase",color:MI,marginBottom:5}},T.fromLang),
      h("select",{value:sLang,onChange:e=>setSLang(e.target.value),style:SS},
        h("option",{value:"auto"},T.autoDetect),
        LANGS.map(l=>h("option",{key:l,value:l},l)))
    )
  );
}

// â”€â”€ UnitsToggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function UnitsToggle({units,setUnits,T}){
  const btn=(val,label)=>h("button",{
    className:"tog-btn",
    onClick:()=>setUnits(val),
    style:{flex:1,padding:"7px 4px",border:"none",borderRadius:4,fontFamily:"sans-serif",fontSize:10,fontWeight:700,letterSpacing:"0.07em",cursor:"pointer",
      background:units===val?F:"transparent",color:units===val?CR:MI}
  },label);
  return h("div",{style:{marginBottom:16}},
    h("label",{style:{display:"block",fontFamily:"sans-serif",fontSize:9,fontWeight:700,letterSpacing:"0.15em",textTransform:"uppercase",color:MI,marginBottom:5}},T.unitsLabel),
    h("div",{style:{display:"flex",gap:2,background:PA,borderRadius:6,padding:2,border:"1px solid "+BO}},
      btn("metric",T.metric),
      btn("imperial",T.imperial)
    )
  );
}

// â”€â”€ App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App(){
  const [uiLang,  setUiLang]  = useState(()=>detectUiLang());
  const [tab,     setTab]     = useState("text");
  const [input,   setInput]   = useState(EXAMPLE);
  const [url,     setUrl]     = useState("");
  const [imgs,    setImgs]    = useState([]);
  const [tLang,   setTLang]   = useState("Swedish");
  const [sLang,   setSLang]   = useState("auto");
  const [units,   setUnits]   = useState("metric");
  const [result,  setResult]  = useState(null);
  // â”€â”€ TTS state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const [ttsPlaying,setTtsPlaying] = useState(false);
  const [ttsPaused, setTtsPaused]  = useState(false);
  const [ttsIdx,    setTtsIdx]     = useState(0);     // current segment index
  const ttsSegsRef  = React.useRef([]);  // built from recipe
  const ttsIdxRef   = React.useRef(0);  // mirrored for closure access
  const ttsActiveRef= React.useRef(false);

  // Build flat segment list from recipe
  function buildTtsSegments(rec, targetLang) {
    const RL = getRecipeLabels(targetLang);
    const segs = [];
    if (rec.titel)        segs.push({text:rec.titel,                    type:'title',  idx:null});
    if (rec.beskrivning)  segs.push({text:rec.beskrivning,              type:'desc',   idx:null});
    if ((rec.ingredienser||[]).length) {
      segs.push({text:RL.ingredients,                                   type:'head',   idx:null});
      (rec.ingredienser||[]).forEach((ing,i) => {
        const t = [ing.mangd, ing.ingrediens].filter(Boolean).join(' ');
        if (t.trim()) segs.push({text:t, type:'ing', idx:i});
      });
    }
    if ((rec.steg||[]).length) {
      (rec.steg||[]).forEach((s,i) =>
        segs.push({text:(RL.stepWord+' '+(i+1)+'. '+s), type:'step', idx:i})
      );
    }
    if (rec.noteringar)   segs.push({text:rec.noteringar,               type:'notes',  idx:null});
    return segs;
  }

  // Get best voice for lang code
  function getBestVoice(langCode) {
    const voices = window.speechSynthesis ? window.speechSynthesis.getVoices() : [];
    return voices.find(v => v.lang === langCode)
        || voices.find(v => v.lang.startsWith(langCode.slice(0,2)))
        || null;
  }

  // Speak one segment, call onEnd when done
  function speakSegment(seg, langCode, onEnd) {
    if (!window.speechSynthesis) return;
    // Split long text into sentences to work around Chrome's ~15s cutoff bug.
    // Chrome silently stops speaking utterances longer than ~200-250 chars.
    const MAX = 220;
    const text = seg.text || '';
    const chunks = [];
    if (text.length <= MAX) {
      chunks.push(text);
    } else {
      // Split on sentence boundaries first, then hard-cap remaining
      const sentences = text.match(/[^.!?]+[.!?]*\s*/g) || [text];
      let buf = '';
      for (const s of sentences) {
        if ((buf + s).length > MAX && buf) { chunks.push(buf.trim()); buf = s; }
        else buf += s;
      }
      if (buf.trim()) chunks.push(buf.trim());
    }

    // Speak all chunks in sequence; only fire onEnd after the last one.
    // onerror does NOT call onEnd â€” cancel() fires onerror with "interrupted"
    // which previously caused the next segment to play twice.
    let ci = 0;
    function speakChunk() {
      if (ci >= chunks.length) { onEnd(); return; }
      const u = new SpeechSynthesisUtterance(chunks[ci]);
      u.lang = langCode;
      const voice = getBestVoice(langCode);
      if (voice) u.voice = voice;
      u.rate = 0.92;
      u.onend = () => { ci++; speakChunk(); };
      u.onerror = (e) => {
        // "interrupted" / "canceled" = we cancelled deliberately, don't advance
        if (e.error === 'interrupted' || e.error === 'canceled') return;
        // Real error: skip to next segment
        onEnd();
      };
      window.speechSynthesis.speak(u);
    }
    speakChunk();
  }

  // Advance through segments
  function ttsAdvance(idx, segs, langCode) {
    if (!ttsActiveRef.current || idx >= segs.length) {
      setTtsPlaying(false); setTtsPaused(false); setTtsIdx(0);
      ttsIdxRef.current = 0; ttsActiveRef.current = false;
      return;
    }
    ttsIdxRef.current = idx;
    setTtsIdx(idx);
    speakSegment(segs[idx], langCode, () => ttsAdvance(idx+1, segs, langCode));
  }

  function ttsPlay() {
    if (!window.speechSynthesis) return;
    const segs = ttsSegsRef.current;
    if (!segs.length) return;
    const langCode = LANG_TO_BCP47[tLang] || 'sv-SE';
    if (ttsPaused) {
      window.speechSynthesis.resume();
      setTtsPaused(false); setTtsPlaying(true);
      return;
    }
    window.speechSynthesis.cancel();
    ttsActiveRef.current = true;
    setTtsPlaying(true); setTtsPaused(false);
    ttsAdvance(ttsIdxRef.current, segs, langCode);
  }

  function ttsPause() {
    if (!window.speechSynthesis) return;
    window.speechSynthesis.pause();
    setTtsPaused(true); setTtsPlaying(false);
  }

  function ttsStop() {
    if (!window.speechSynthesis) return;
    ttsActiveRef.current = false;
    window.speechSynthesis.cancel();
    setTtsPlaying(false); setTtsPaused(false);
    setTtsIdx(0); ttsIdxRef.current = 0;
  }

  // Reset TTS when result changes
  React.useEffect(() => {
    ttsStop();
    if (result) {
      ttsSegsRef.current = buildTtsSegments(result, tLang);
    }
  }, [result]);

  // Auto-scroll to active TTS segment
  React.useEffect(() => {
    if (!(ttsPlaying || ttsPaused)) return;
    const seg = ttsSegsRef.current[ttsIdx];
    if (!seg) return;
    const id = seg.type === 'step' ? 'tts-step-' + seg.idx
              : seg.type === 'ing'  ? 'tts-ing-'  + seg.idx
              : null;
    if (!id) return;
    const el = document.getElementById(id);
    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }, [ttsIdx, ttsPlaying, ttsPaused]);
  const [srcUrl,  setSrcUrl]  = useState(null);
  const [scale,   setScale]   = useState(1);
  const [busy,    setBusy]    = useState(false);
  const [status,  setStatus]  = useState("");
  const [copied,  setCopied]  = useState(false);
  const [info,    setInfo]    = useState(false);
  const [winW,    setWinW]    = useState(window.innerWidth);
  const fileRef=useRef();

  useEffect(()=>{
    const fn=()=>setWinW(window.innerWidth);
    window.addEventListener("resize",fn);
    return()=>window.removeEventListener("resize",fn);
  },[]);

  // Update page title when UI lang changes
  useEffect(()=>{
    document.title=UI_STRINGS[uiLang].siteTitle;
  },[uiLang]);

  const T=UI_STRINGS[uiLang];
  const mobile=winW<640;
  const medium=winW<860;

  // Image compression
  function compressAndAdd(file){
    if(!file||!file.type.startsWith("image/"))return setStatus(T.imgFormat);
    if(imgs.length>=MAX_IMGS)return setStatus("Max "+MAX_IMGS);
    setStatus("...");
    const reader=new FileReader();
    reader.onload=function(e){
      const orig=e.target.result;
      const img=new Image();
      img.onload=function(){
        const MAX=1200;let w=img.width,hh=img.height;
        if(w>MAX||hh>MAX){const s=MAX/Math.max(w,hh);w=Math.round(w*s);hh=Math.round(hh*s);}
        const canvas=document.createElement("canvas");canvas.width=w;canvas.height=hh;
        canvas.getContext("2d").drawImage(img,0,0,w,hh);
        const compressed=canvas.toDataURL("image/jpeg",0.82);
        const b64=compressed.split(",")[1];
        if(b64.length>1_200_000)return setStatus("Image too large after compression.");
        setImgs(prev=>[...prev,{b64,mime:"image/jpeg",src:compressed}]);setStatus("");
      };
      img.onerror=()=>setStatus("Could not read image.");
      img.src=orig;
    };
    reader.readAsDataURL(file);
  }
  function removeImg(i){setImgs(prev=>prev.filter((_,idx)=>idx!==i));}

  // Translate
  async function translate(){
    setStatus("");setResult(null);setScale(1);setBusy(true);
    try{
      let recipe;
      if(tab==="text"){
        if(!input.trim())throw new Error(T.pasteLabel);
        setStatus(T.btnTranslate+"...");
        recipe=await callBackend({type:"text",content:input,targetLanguage:tLang,sourceLanguage:sLang,measurementSystem:units});
        setSrcUrl(null);
      }else if(tab==="url"){
        if(!url.trim())throw new Error(T.urlLabel);
        setStatus(T.btnTranslate+"...");
        recipe=await callBackend({type:"url",url:url.trim(),targetLanguage:tLang,measurementSystem:units});
        setSrcUrl(url.trim());
      }else{
        if(!imgs.length)throw new Error(T.imgSlotFirst);
        setStatus(T.btnImg+"...");
        recipe=await callBackend({type:"image",images:imgs.map(i=>({b64:i.b64,mime:i.mime})),targetLanguage:tLang,measurementSystem:units});
        setSrcUrl(null);
      }
      recipe._fetchedAt=new Date().toLocaleDateString("sv-SE");
      recipe._tLang=tLang;
      setResult(recipe);setStatus("");
    }catch(e){setStatus(e.message);}
    finally{setBusy(false);}
  }


  function doCopy(){
    if(!result)return;
    const text=buildPlainText(result,srcUrl,scale,T);
    const ok=()=>{setCopied(true);setTimeout(()=>setCopied(false),2500);};
    if(navigator.clipboard&&navigator.clipboard.writeText)navigator.clipboard.writeText(text).then(ok).catch(()=>fbCopy(text,ok));
    else fbCopy(text,ok);
  }
  function fbCopy(text,ok){
    const ta=document.createElement("textarea");ta.value=text;ta.style.cssText="position:fixed;opacity:0";
    document.body.appendChild(ta);ta.focus();ta.select();document.execCommand("copy");document.body.removeChild(ta);ok();
  }

  const m=result?.meta||{};
  const chips=[
    m.portioner&&scale!==1?scalePortioner(m.portioner,scale):m.portioner,
    m.totaltid&&"Totalt: "+m.totaltid,
    m.svarighetsgrad
  ].filter(Boolean);
  const hasPortions=m.portioner&&/\d/.test(m.portioner);

  // Result heading with source language
  const detLang=result?.detectedLanguage;
  const langMap=LANG_NAMES[uiLang]||LANG_NAMES["en"];
  const toLangStr=langMap[tLang]||tLang;
  const resultHeading=detLang
    ?T.resultFrom+" "+detLang+" "+T.resultTo+" "+toLangStr
    :T.resultPrefix+" "+toLangStr;

  const metricPairs=[["cups","dl"],["oz","g"],["sticks","g"],["lbs","kg"],["Â°F","Â°C"],["tbsp","msk"],["tsp","tsk"],["pint","dl"],["inch","cm"],["gallon","L"]];
  const imperialPairs=[["dl","cups"],["g","oz"],["kg","lbs"],["Â°C","Â°F"],["msk","tbsp"],["tsk","tsp"],["cm","inch"],["L","gallon"]];
  const convPairs=units==="metric"?metricPairs:imperialPairs;

  return h("div",{style:{background:CR,minHeight:"100vh",paddingBottom:100}},

    // Header
    h("header",{style:{background:"#1c3028",borderBottom:"3px solid "+T2}},
      h("div",{style:{background:PA,borderBottom:"1px solid "+BO,padding:"4px 0 0",overflow:"hidden"}},h(SumiIllustration,null)),
      h("div",{style:{padding:mobile?"12px 14px 10px":"18px 32px 16px",display:"flex",alignItems:"center",justifyContent:"space-between",gap:8}},
        h("div",null,
          h("div",{style:{display:"flex",alignItems:"center",gap:10,marginBottom:6}},
            h("div",{style:{width:26,height:2,background:T2,borderRadius:2}}),
            h("span",{style:{color:"rgba(237,230,214,0.45)",fontSize:9,letterSpacing:"0.2em",textTransform:"uppercase",fontFamily:"sans-serif"}},T.subtitle)
          ),
          h("h1",{style:{margin:0,lineHeight:1,fontFamily:"'Palatino Linotype','Georgia',serif",fontWeight:400}},
            h("span",{style:{fontSize:"clamp(26px,5vw,50px)",color:CR}},T.titlePart1),
            h("span",{style:{fontSize:"clamp(26px,5vw,50px)",color:G,fontStyle:"italic"}},T.titlePart2)
          )
        ),
        h("div",{style:{display:"flex",alignItems:"center",gap:8}},
          h(LangPicker,{uiLang,setUiLang}),
          h("button",{
            className:"info-btn",
            onClick:()=>setInfo(v=>!v),
            style:{background:"rgba(201,168,76,0.12)",border:"1.5px solid rgba(201,168,76,0.45)",borderRadius:7,padding:"6px 12px",color:G,fontSize:12,fontWeight:700,cursor:"pointer",flexShrink:0,display:"flex",alignItems:"center",gap:5,letterSpacing:"0.05em",fontFamily:"sans-serif"}
          },
            h("span",{style:{fontSize:15,lineHeight:1}},"â“˜"),
            mobile?null:h("span",null,T.infoBtn)
          )
        )
      )
    ),

    // Info modal
    info&&h("div",{onClick:()=>setInfo(false),style:{position:"fixed",inset:0,background:"rgba(20,30,26,0.6)",zIndex:100,display:"flex",alignItems:"center",justifyContent:"center",padding:24}},
      h("div",{onClick:e=>e.stopPropagation(),style:{background:WA,borderRadius:10,border:"1px solid "+BO,maxWidth:540,width:"100%",boxShadow:"0 16px 48px rgba(0,0,0,0.28)",overflow:"hidden"}},
        h("div",{style:{background:PA,padding:"13px 20px",borderBottom:"1px solid "+BO,display:"flex",justifyContent:"space-between",alignItems:"center"}},
          h("span",{style:{fontFamily:"'Palatino Linotype','Georgia',serif",fontStyle:"italic",fontSize:16,color:F}},T.infoTitle),
          h("button",{onClick:()=>setInfo(false),style:{background:"transparent",border:"none",color:MI,fontSize:24,cursor:"pointer",lineHeight:1,padding:"0 2px"}},"Ã—")
        ),
        h("div",{style:{padding:"20px 24px",fontFamily:"sans-serif",fontSize:13,color:MI,lineHeight:1.85}},
          h("p",{style:{margin:"0 0 11px",fontWeight:700,color:F,fontSize:14}},T.infoWelcome),
          h("p",{style:{margin:"0 0 11px"}},T.infoP1),
          h("p",{style:{margin:"0 0 11px"}},T.infoP2),
          h("p",{style:{margin:"0 0 11px"}},T.infoP3),
          h("p",{style:{margin:0,fontSize:12,color:"#9a9088",borderTop:"1px solid "+BO,paddingTop:13}},T.infoFooter)
        )
      )
    ),

    // Main
    h("main",{style:{maxWidth:920,margin:"0 auto",padding:mobile?"16px 12px 0":"30px 20px 0"}},

      // Tabs
      h("div",{style:{display:"flex",borderBottom:"2px solid "+BO,marginBottom:16,overflowX:"auto"}},
        [[" text",T.tabText],["url",T.tabUrl],["image",T.tabImg]].map(([t,l])=>{
          const tv=t.trim();
          return h("button",{key:tv,onClick:()=>{setTab(tv);setStatus("");},
            style:{padding:mobile?"9px 12px":"10px 22px",border:"none",background:tab===tv?PA:"transparent",fontFamily:"sans-serif",fontSize:mobile?10:11,fontWeight:tab===tv?700:500,letterSpacing:"0.08em",textTransform:"uppercase",color:tab===tv?F:MI,borderBottom:"2px solid "+(tab===tv?F:"transparent"),marginBottom:-2,cursor:"pointer",borderRadius:"4px 4px 0 0",whiteSpace:"nowrap",flexShrink:0}},l);
        })
      ),

      // Grid
      h("div",{style:{display:"grid",gridTemplateColumns:medium?"1fr":"1fr 236px",gap:mobile?12:20}},

        // Left
        h("div",null,
          h(LangBar,{tab,tLang,setTLang,sLang,setSLang,mobile,T}),
          h(UnitsToggle,{units,setUnits,T}),

          // Text tab
          tab==="text"&&h("div",{style:{background:WA,borderRadius:8,border:"1px solid "+BO,boxShadow:"0 1px 8px rgba(45,74,62,0.06)",overflow:"hidden"}},
            h("div",{style:{background:PA,padding:"8px 16px",borderBottom:"1px solid "+BO,display:"flex",justifyContent:"space-between",alignItems:"center"}},
              h("span",{style:{fontFamily:"sans-serif",fontSize:9,fontWeight:700,letterSpacing:"0.15em",textTransform:"uppercase",color:MI}},T.pasteLabel),
              h("button",{onClick:()=>setInput(""),style:{background:"transparent",border:"none",color:MI,fontSize:11,cursor:"pointer"}},T.clear)
            ),
            h("textarea",{value:input,onChange:e=>setInput(e.target.value),style:{width:"100%",minHeight:mobile?180:260,padding:"14px 18px",border:"none",background:"transparent",fontFamily:"Georgia,serif",fontSize:13,lineHeight:1.85,resize:"vertical",outline:"none",color:"#6b6258",fontStyle:"italic",boxSizing:"border-box"}})
          ),

          // URL tab
          tab==="url"&&h("div",{style:{background:WA,borderRadius:8,border:"1px solid "+BO,padding:20,boxShadow:"0 1px 8px rgba(45,74,62,0.06)"}},
            h("label",{style:{display:"block",fontFamily:"sans-serif",fontSize:9,fontWeight:700,letterSpacing:"0.15em",textTransform:"uppercase",color:MI,marginBottom:8}},T.urlLabel),
            h("input",{type:"text",value:url,onChange:e=>setUrl(e.target.value),placeholder:"https://www.allrecipes.com/recipe/...",style:{width:"100%",padding:"10px 12px",border:"1px solid "+BO,borderRadius:6,fontFamily:"Georgia,serif",fontSize:13,outline:"none",color:"#2a2a2a",marginBottom:14,boxSizing:"border-box",background:CR}}),
            h("div",{style:{borderTop:"1px solid "+BO,paddingTop:13,fontFamily:"sans-serif",fontSize:12,color:MI,lineHeight:1.8}},
              h("div",{style:{fontWeight:700,color:F,marginBottom:3,fontSize:11}},T.worksWith),
              "AllRecipes Â· Food Network Â· NYT Cooking",h("br",null),"Serious Eats Â· Epicurious Â· BBC Good Food"
            )
          ),

          // Image tab
          tab==="image"&&h("div",null,
            h("input",{ref:fileRef,type:"file",accept:"image/*",style:{display:"none"},onChange:e=>{if(e.target.files[0])compressAndAdd(e.target.files[0]);e.target.value="";}}),
            h("div",{style:{display:"grid",gridTemplateColumns:"repeat(2,1fr)",gap:9,marginBottom:10}},
              imgs.map((img,i)=>
                h("div",{key:i,style:{position:"relative",borderRadius:8,overflow:"hidden",border:"1px solid "+BO,aspectRatio:"4/3",background:"#e8e0d0"}},
                  h("img",{src:img.src,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"}}),
                  h("button",{onClick:()=>removeImg(i),style:{position:"absolute",top:5,right:5,background:"rgba(0,0,0,0.55)",border:"none",borderRadius:"50%",width:24,height:24,color:"#fff",fontSize:14,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",lineHeight:1}},"Ã—")
                )
              ),
              imgs.length<MAX_IMGS&&h("div",{
                className:"img-slot",
                onClick:()=>fileRef.current.click(),
                onDragOver:e=>e.preventDefault(),
                onDrop:e=>{e.preventDefault();if(e.dataTransfer.files[0])compressAndAdd(e.dataTransfer.files[0]);},
                style:{borderRadius:8,border:"2px dashed "+BO,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",cursor:"pointer",aspectRatio:"4/3",background:WA,gap:7}
              },
                h("div",{style:{fontSize:imgs.length===0?38:26,opacity:0.5}},"ğŸ“·"),
                h("div",{style:{fontFamily:"sans-serif",fontSize:11,color:MI,textAlign:"center",padding:"0 8px"}},
                  imgs.length===0?T.imgSlotFirst:T.imgSlotAdd)
              )
            ),
            imgs.length===0&&h("div",{style:{fontFamily:"sans-serif",fontSize:11,color:BO,textAlign:"center",marginBottom:9}},T.imgFormat),
            imgs.length>0&&h("div",{style:{fontFamily:"sans-serif",fontSize:11,color:MI,marginBottom:9}},
              imgs.length+T.imgCount1+MAX_IMGS+T.imgCount2+(imgs.length<MAX_IMGS?T.imgCountMore:"")),
            h("div",{style:{background:PA,borderRadius:6,padding:"10px 14px",fontFamily:"sans-serif",fontSize:12,color:MI,lineHeight:1.7,border:"1px solid "+BO}},
              h("strong",{style:{color:F}},T.imgTipLabel),T.imgTip)
          )
        ),

        // Sidebar
        h("div",{style:{display:"flex",flexDirection:"column",gap:13}},
          !mobile&&h("div",{style:{background:WA,borderRadius:8,border:"1px solid "+BO,padding:"14px 16px",boxShadow:"0 1px 8px rgba(45,74,62,0.06)"}},
            h("div",{style:{fontFamily:"'Palatino Linotype','Georgia',serif",fontStyle:"italic",color:F,fontSize:14,marginBottom:9,paddingBottom:8,borderBottom:"1px solid "+BO}},T.converts),
            h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"5px 9px"}},
              convPairs.map(([a,b])=>
                h("div",{key:a,style:{display:"flex",alignItems:"center",gap:4,fontFamily:"Georgia,serif",fontSize:12,color:MI}},
                  h("span",{style:{color:T2}}," "+a+" "),
                  h("span",{style:{color:BO,fontSize:11}},"â‡„"),
                  h("span",{style:{color:F}}," "+b)
                )
              )
            )
          ),
          h("button",{onClick:translate,disabled:busy,style:{background:busy?"#7e9e96":F,color:CR,border:"none",borderRadius:6,padding:"13px 9px",fontFamily:"sans-serif",fontSize:11,fontWeight:700,letterSpacing:"0.12em",textTransform:"uppercase",cursor:busy?"not-allowed":"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:8,boxShadow:busy?"none":"0 4px 16px rgba(45,74,62,0.3)"}},
            busy
              ?[h("span",{key:"sp",style:{width:13,height:13,border:"2px solid rgba(237,230,214,0.3)",borderTopColor:CR,borderRadius:"50%",display:"inline-block",animation:"spin .7s linear infinite",flexShrink:0,boxSizing:"content-box"}}),status]
              :tab==="image"?T.btnImg:T.btnTranslate
          ),
          status&&!busy&&h("div",{style:{background:"#fdf0ed",borderLeft:"3px solid "+T2,borderRadius:"0 6px 6px 0",padding:"10px 12px",fontFamily:"sans-serif",fontSize:12,color:T2,lineHeight:1.65}},status)
        )
      ),

      // Result
      result&&h("div",{style:{marginTop:40,background:WA,borderRadius:8,border:"1px solid "+BO,boxShadow:"0 4px 28px rgba(45,74,62,0.09)",overflow:"hidden"}},
        h("div",{style:{background:PA,padding:"10px 20px",borderBottom:"1px solid "+BO,display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:9}},
          h("span",{style:{fontFamily:"'Palatino Linotype','Georgia',serif",fontStyle:"italic",color:F,fontSize:13}},resultHeading),
          h("div",{style:{display:"flex",gap:8,flexWrap:"wrap"}},
            h("button",{onClick:doCopy,style:{padding:"7px 14px",borderRadius:5,border:"1.5px solid "+F,background:copied?F:"transparent",color:copied?CR:F,fontFamily:"sans-serif",fontSize:10,fontWeight:700,letterSpacing:"0.09em",textTransform:"uppercase",cursor:"pointer"}},copied?T.copiedBtn:T.copyBtn),
            h("button",{onClick:()=>generatePDF(result,T),style:{padding:"7px 14px",borderRadius:5,border:"none",background:T2,color:"#fff",fontFamily:"sans-serif",fontSize:10,fontWeight:700,letterSpacing:"0.09em",textTransform:"uppercase",cursor:"pointer",boxShadow:"0 2px 10px rgba(184,92,56,0.3)"}},T.pdfBtn)
          )
        ),
        // TTS player bar
        (window.speechSynthesis)&&h("div",{style:{borderTop:"1px solid "+BO,background:ttsPlaying||ttsPaused?"#f0ede6":PA,padding:"10px 18px",display:"flex",alignItems:"center",gap:10,flexWrap:"wrap",transition:"background 0.3s"}},
          h("div",{style:{display:"flex",gap:6,alignItems:"center"}},
            // Prev segment â€” only when active
            (ttsPlaying||ttsPaused)&&h("button",{
              onClick:()=>{ const prev=Math.max(0,ttsIdxRef.current-1); ttsIdxRef.current=prev; setTtsIdx(prev); window.speechSynthesis.cancel(); ttsActiveRef.current=true; setTtsPlaying(true); setTtsPaused(false); speakSegment(ttsSegsRef.current[prev], LANG_TO_BCP47[tLang]||"sv-SE", ()=>ttsAdvance(prev+1,ttsSegsRef.current,LANG_TO_BCP47[tLang]||"sv-SE")); },
              title:"FÃ¶regÃ¥ende",
              style:{width:30,height:30,borderRadius:"50%",border:"1.5px solid "+BO,background:"transparent",color:ttsIdx>0?F:BO,cursor:ttsIdx>0?"pointer":"default",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,transition:"all 0.15s"}},
              h("svg",{width:11,height:11,viewBox:"0 0 24 24",fill:"currentColor"},
                h("polygon",{points:"19,5 9,12 19,19"}),h("rect",{x:5,y:5,width:3,height:14}))
            ),
            // Play/Pause button
            h("button",{
              onClick:ttsPlaying?ttsPause:ttsPlay,
              title:ttsPlaying?T.ttsPause:(ttsPaused?T.ttsResume:T.ttsPlay),
              style:{width:38,height:38,borderRadius:"50%",border:"none",background:ttsPlaying?T2:(ttsPaused?"rgba(184,92,56,0.7)":F),color:"#fff",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,boxShadow:"0 2px 8px rgba(0,0,0,0.18)",transition:"background 0.2s"}},
              ttsPlaying
                ? h("svg",{width:14,height:14,viewBox:"0 0 24 24",fill:"currentColor"},h("rect",{x:5,y:3,width:4,height:18}),h("rect",{x:15,y:3,width:4,height:18}))
                : h("svg",{width:14,height:14,viewBox:"0 0 24 24",fill:"currentColor"},h("polygon",{points:"5,3 19,12 5,21"}))
            ),
            // Next segment â€” only when active
            (ttsPlaying||ttsPaused)&&h("button",{
              onClick:()=>{ const next=Math.min(ttsSegsRef.current.length-1,ttsIdxRef.current+1); ttsIdxRef.current=next; setTtsIdx(next); window.speechSynthesis.cancel(); ttsActiveRef.current=true; setTtsPlaying(true); setTtsPaused(false); speakSegment(ttsSegsRef.current[next], LANG_TO_BCP47[tLang]||"sv-SE", ()=>ttsAdvance(next+1,ttsSegsRef.current,LANG_TO_BCP47[tLang]||"sv-SE")); },
              title:"NÃ¤sta",
              style:{width:30,height:30,borderRadius:"50%",border:"1.5px solid "+BO,background:"transparent",color:ttsIdx<ttsSegsRef.current.length-1?F:BO,cursor:ttsIdx<ttsSegsRef.current.length-1?"pointer":"default",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,transition:"all 0.15s"}},
              h("svg",{width:11,height:11,viewBox:"0 0 24 24",fill:"currentColor"},
                h("polygon",{points:"5,5 15,12 5,19"}),h("rect",{x:16,y:5,width:3,height:14}))
            ),
            // Stop button â€” only visible when active
            (ttsPlaying||ttsPaused)&&h("button",{
              onClick:ttsStop,
              title:T.ttsStop,
              style:{width:30,height:30,borderRadius:"50%",border:"1.5px solid "+BO,background:"transparent",color:MI,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,transition:"all 0.15s"}},
              h("svg",{width:11,height:11,viewBox:"0 0 24 24",fill:"currentColor"},h("rect",{x:3,y:3,width:18,height:18,rx:2}))
            )
          ),
          // Label + progress
          h("div",{style:{display:"flex",flexDirection:"column",gap:2,flex:1,minWidth:120}},
            h("span",{style:{fontFamily:"sans-serif",fontSize:10,fontWeight:700,letterSpacing:"0.08em",textTransform:"uppercase",color:ttsPlaying?T2:MI,transition:"color 0.2s"}},
              ttsPlaying||ttsPaused
                ? (ttsSegsRef.current[ttsIdx]?.type==='step'
                    ? getRecipeLabels(tLang).stepWord+' '+(ttsSegsRef.current[ttsIdx]?.idx+1)+' '+T.ttsOf+' '+(result.steg||[]).length
                    : ttsSegsRef.current[ttsIdx]?.type==='ing'
                    ? getRecipeLabels(tLang).ingredients+' '+(ttsSegsRef.current[ttsIdx]?.idx+1)+' '+T.ttsOf+' '+(result.ingredienser||[]).length
                    : ttsSegsRef.current[ttsIdx]?.type==='title'
                    ? (result.titel||'')
                    : ttsSegsRef.current[ttsIdx]?.type==='notes'||ttsSegsRef.current[ttsIdx]?.type==='notes-header'
                    ? (T.notes||'Tips')
                    : getRecipeLabels(tLang).ingredients)
                : T.ttsPlay
            ),
            (ttsPlaying||ttsPaused)&&h("div",{style:{height:3,background:BO,borderRadius:2,overflow:"hidden"}},
              h("div",{style:{height:"100%",background:T2,borderRadius:2,width:(ttsSegsRef.current.length>0?((ttsIdx+1)/ttsSegsRef.current.length*100):0)+"%",transition:"width 0.4s ease"}})
            )
          )
        ),
        h("div",{style:{padding:mobile?"20px 15px":"36px 44px"}},
          h("div",{style:{display:"flex",alignItems:"flex-start",gap:14,marginBottom:7}},
            h("div",{style:{width:4,minHeight:46,background:T2,borderRadius:2,flexShrink:0,marginTop:3}}),
            h("h2",{style:{margin:0,fontFamily:"'Palatino Linotype','Georgia',serif",fontSize:"clamp(21px,3.8vw,33px)",fontWeight:400,color:F,lineHeight:1.15}},result.titel)
          ),
          result.beskrivning&&h("div",{style:{marginLeft:18,marginBottom:20,fontFamily:"Georgia,serif",fontSize:14,color:MI,lineHeight:1.8,fontStyle:"italic",borderLeft:"2px solid "+G,paddingLeft:14}},result.beskrivning),

          (chips.length>0||hasPortions)&&h("div",{style:{marginBottom:26,display:"flex",flexWrap:"wrap",alignItems:"center",gap:9}},
            chips.length>0&&h("div",{style:{display:"inline-flex",flexWrap:"wrap",border:"1px solid "+BO,borderRadius:6,overflow:"hidden"}},
              chips.map((c,i)=>h("div",{key:i,style:{padding:"7px 16px",fontFamily:"sans-serif",fontSize:11,color:F,fontWeight:600,background:i%2===0?PA:WA,borderRight:i<chips.length-1?"1px solid "+BO:"none"}},c))
            ),
            hasPortions&&h("div",{style:{display:"flex",alignItems:"center",gap:5,fontFamily:"sans-serif",fontSize:11}},
              h("span",{style:{color:MI,fontSize:10}},T.scaleLabel),
              [0.5,1,2,3].map(s=>
                h("button",{key:s,onClick:()=>setScale(s),style:{padding:"5px 9px",borderRadius:5,border:"1.5px solid "+(scale===s?F:BO),background:scale===s?F:"transparent",color:scale===s?CR:MI,fontFamily:"sans-serif",fontSize:10,fontWeight:700,cursor:"pointer"}},
                  s===0.5?"Â½x":s+"x")
              )
            )
          ),

          h("div",{style:{display:"flex",alignItems:"center",gap:12,margin:"0 0 14px"}},
            h("span",{style:{fontFamily:"'Palatino Linotype','Georgia',serif",fontStyle:"italic",fontSize:18,color:T2,whiteSpace:"nowrap"}},getRecipeLabels(tLang).ingredients),
            h("div",{style:{flex:1,height:1,background:BO}})
          ),
          h("ul",{style:{listStyle:"none",padding:0,margin:"0 0 8px"}},
            (result.ingredienser||[]).map((ing,i)=>{
              const grp=ing.grupp||"",prev=result.ingredienser[i-1];
              const newG=grp&&(!prev||(prev.grupp||"")!==grp);
              const ingActive=(ttsPlaying||ttsPaused)&&ttsSegsRef.current[ttsIdx]?.type==='ing'&&ttsSegsRef.current[ttsIdx]?.idx===i;
              const ingRow=h("li",{key:"i"+i,id:"tts-ing-"+i,
                style:{display:"grid",gridTemplateColumns:mobile?"86px 1fr":"110px 1fr",padding:"6px 0",fontFamily:"sans-serif",fontSize:mobile?12:13,borderBottom:"1px dotted "+BO,alignItems:"baseline",gap:8,borderRadius:4,background:ingActive?"rgba(184,92,56,0.10)":"transparent",transition:"background 0.3s",marginLeft:-4,paddingLeft:4,cursor:(ttsPlaying||ttsPaused)?"pointer":"default"},
                onClick:()=>{if(!(ttsPlaying||ttsPaused))return;const segI=ttsSegsRef.current.findIndex(s=>s.type==='ing'&&s.idx===i);if(segI<0)return;ttsIdxRef.current=segI;setTtsIdx(segI);window.speechSynthesis.cancel();ttsActiveRef.current=true;setTtsPlaying(true);setTtsPaused(false);speakSegment(ttsSegsRef.current[segI],LANG_TO_BCP47[tLang]||'sv-SE',()=>ttsAdvance(segI+1,ttsSegsRef.current,LANG_TO_BCP47[tLang]||'sv-SE'));}},
                h("span",{style:{fontWeight:700,color:ingActive?T2:F,transition:"color 0.3s"}},scaleAmount(ing.mangd,scale)||""),
                h("span",{style:{color:"#2a2a2a",fontWeight:ingActive?600:400}},ing.ingrediens)
              );
              if(newG) return h(React.Fragment,{key:"f"+i},
                h("li",{key:"g"+i,style:{padding:"12px 0 3px",fontFamily:"sans-serif",fontSize:9,fontWeight:700,letterSpacing:"0.17em",textTransform:"uppercase",color:T2,borderTop:"1px solid "+BO}},grp),
                ingRow
              );
              return ingRow;
            })
          ),

          h("div",{style:{display:"flex",alignItems:"center",gap:12,margin:"26px 0 14px"}},
            h("span",{style:{fontFamily:"'Palatino Linotype','Georgia',serif",fontStyle:"italic",fontSize:18,color:T2,whiteSpace:"nowrap"}},getRecipeLabels(tLang).steps),
            h("div",{style:{flex:1,height:1,background:BO}})
          ),
          h("ol",{style:{listStyle:"none",padding:0,margin:0}},
            (result.steg||[]).map((s,i)=>{
              const stepActive=(ttsPlaying||ttsPaused)&&ttsSegsRef.current[ttsIdx]?.type==='step'&&ttsSegsRef.current[ttsIdx]?.idx===i;
              return h("li",{key:i,id:"tts-step-"+i,style:{display:"flex",gap:mobile?10:15,marginBottom:14,fontFamily:"sans-serif",fontSize:mobile?12:13,lineHeight:1.85,borderRadius:6,background:stepActive?"rgba(184,92,56,0.08)":"transparent",padding:stepActive?"10px 12px":"0",marginLeft:stepActive?-12:0,transition:"all 0.3s",cursor:(ttsPlaying||ttsPaused)?"pointer":"default"},onClick:()=>{if(!(ttsPlaying||ttsPaused))return;const segI=ttsSegsRef.current.findIndex(s=>s.type==='step'&&s.idx===i);if(segI<0)return;ttsIdxRef.current=segI;setTtsIdx(segI);window.speechSynthesis.cancel();ttsActiveRef.current=true;setTtsPlaying(true);setTtsPaused(false);speakSegment(ttsSegsRef.current[segI],LANG_TO_BCP47[tLang]||'sv-SE',()=>ttsAdvance(segI+1,ttsSegsRef.current,LANG_TO_BCP47[tLang]||'sv-SE'));}},
                h("span",{style:{display:"flex",alignItems:"center",justifyContent:"center",minWidth:27,height:27,background:stepActive?T2:F,color:CR,borderRadius:"50%",fontSize:11,fontWeight:700,flexShrink:0,marginTop:stepActive?0:2,transition:"background 0.3s,margin 0.3s,box-shadow 0.3s",boxShadow:stepActive?"0 2px 10px rgba(184,92,56,0.45)":"none"}},i+1),
                h("span",{style:{paddingTop:3,color:stepActive?"#1a1a1a":"#2a2a2a",fontWeight:stepActive?600:400,transition:"color 0.3s,font-weight 0.3s"}},s)
              );
            })
          ),

          result.noteringar&&h("div",null,
            h("div",{style:{display:"flex",alignItems:"center",gap:12,margin:"26px 0 12px"}},
              h("span",{style:{fontFamily:"'Palatino Linotype','Georgia',serif",fontStyle:"italic",fontSize:16,color:MI,whiteSpace:"nowrap"}},T.notes),
              h("div",{style:{flex:1,height:1,background:BO}})
            ),
            h("div",{style:{background:PA,borderLeft:"3px solid "+G,padding:"15px 19px",borderRadius:"0 6px 6px 0",fontFamily:"Georgia,serif",fontSize:13,color:MI,lineHeight:1.8,fontStyle:"italic"}},result.noteringar)
          ),

          (srcUrl||result._fetchedAt)&&h("div",{style:{marginTop:26,paddingTop:12,borderTop:"1px dotted "+BO,fontFamily:"sans-serif",fontSize:11,color:"#aaa098",lineHeight:1.7}},
            h("span",{style:{fontWeight:600}},T.source),
            srcUrl&&h("a",{href:srcUrl,target:"_blank",rel:"noopener",style:{color:"#aaa098",textDecoration:"underline"}},srcUrl),
            result._fetchedAt&&h("span",null," Â· "+result._fetchedAt)
          )
        )
      )
    )
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
</script>
</body>
</html>
